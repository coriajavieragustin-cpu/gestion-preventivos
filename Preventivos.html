<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Gesti√≥n Preventiva - Google Sync</title>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin:15px; background-color: #f0f2f5; color: #333; }
        
        /* Cabecera */
        .header-app { display: flex; align-items: center; background: #fff; padding: 10px 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; gap: 15px; }
        .header-app img { max-height: 40px; }
        .header-app h2 { margin: 0; font-size: 18px; color: #1a73e8; }

        /* Dashboard */
        .resumen-estados { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .card-conteo { padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; background: #fff; border: 1px solid #ddd; font-size: 10px; }
        .card-conteo span { display: block; font-size: 22px; margin-top: 4px; }
        .conteo-pendiente { border-top: 4px solid #dc3545; color: #dc3545; }
        .conteo-noreparable { border-top: 4px solid #6c757d; color: #6c757d; }
        .conteo-proceso { border-top: 4px solid #007bff; color: #007bff; }
        .conteo-finalizado { border-top: 4px solid #28a745; color: #28a745; }

        /* Panel Central */
        .panel-central { display: grid; grid-template-columns: 1.6fr 1fr; gap: 15px; margin-bottom: 15px; height: 500px; }
        #mapa-general { height: 100%; border-radius: 8px; border: 2px solid #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .stats-columna { display: flex; flex-direction: column; gap: 10px; height: 100%; overflow: hidden; }
        .stats-box { background: #fff; padding: 12px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); flex: 1; overflow-y: auto; }
        .stats-box h3 { margin: 0 0 8px 0; font-size: 13px; color: #444; border-bottom: 1px solid #eee; padding-bottom: 4px; }
        .stats-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .stats-table td { padding: 5px 0; border-bottom: 1px dotted #eee; }
        .stats-table td:last-child { text-align: right; font-weight: bold; color: #1a73e8; }

        /* Controles */
        .controles { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; }
        /* Ajuste de grid para acomodar el 5to filtro */
        .filtros-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 15px; background: #f8f9fa; padding: 12px; border-radius: 6px; }
        .grupo-filtro { display: flex; flex-direction: column; gap: 5px; }
        .grupo-filtro label { font-size: 10px; font-weight: bold; color: #666; text-transform: uppercase; }
        .input-busqueda { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; box-sizing: border-box; }

        button { padding: 8px 14px; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 11px; font-weight: 600; transition: 0.2s; margin-bottom: 5px; }
        .btn-nueva { background: #28a745; } 
        .btn-export { background: #17a2b8; } 
        .btn-import { background: #ffc107; color: #333; } 
        .btn-borrar { background: #dc3545; }
        .btn-drive { background: #1fa463; }

        /* Tabla */
        .contenedor-tabla { background: #fff; border-radius: 8px; overflow: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-height: 500px; }
        table.tabla-principal { border-collapse: collapse; width: 100%; min-width: 1200px; }
        .tabla-principal th { padding: 12px; background: #f8f9fa; color: #666; font-size: 11px; text-align: left; border-bottom: 2px solid #dee2e6; position: sticky; top: 0; z-index: 10; }
        .tabla-principal td { padding: 8px 12px; font-size: 11px; border-bottom: 1px solid #eee; }

        .estado-pendiente { background-color: #fff5f5; }
        .estado-noreparable { background-color: #f8f9fa; }
        .estado-enproceso { background-color: #f0f7ff; }
        .estado-finalizado { background-color: #f2fff5; }
        
        .etiqueta-id { background: #333; color: white; border: none; border-radius: 3px; padding: 2px 6px; font-weight: bold; font-size: 10px; }
    </style>
</head>
<body>

    <div class="header-app">
        <img src="logo.png" alt="Logo">
        <h2>GESTI√ìN PREVENTIVOS V1.0 - DRIVE SYNC</h2>
    </div>

    <div class="resumen-estados">
        <div class="card-conteo">TOTAL <span id="res-total">0</span></div>
        <div class="card-conteo conteo-pendiente">PENDIENTES <span id="res-pend">0</span></div>
        <div class="card-conteo conteo-noreparable">NO REPARABLE <span id="res-nr">0</span></div>
        <div class="card-conteo conteo-proceso">EN PROCESO <span id="res-proc">0</span></div>
        <div class="card-conteo conteo-finalizado">FINALIZADOS <span id="res-fin">0</span></div>
    </div>

    <div class="panel-central">
        <div id="mapa-general"></div>
        <div class="stats-columna">
            <div class="stats-box"><h3>üìÖ Historial Cierres</h3><div id="stats-mes"></div></div>
            <div class="stats-box"><h3>üìç Top Zonas</h3><div id="stats-zona"></div></div>
            <div class="stats-box"><h3>üè∑Ô∏è Categor√≠as</h3><div id="stats-categoria"></div></div>
        </div>
    </div>

    <div class="controles">
        <div>
            <button class="btn-nueva" onclick="agregarFila()">‚ûï Nueva tarea</button>
            <button class="btn-drive" id="btnSincronizar" onclick="handleAuthClick()">‚òÅÔ∏è Sincronizar Drive</button>
            <button class="btn-export" onclick="exportarCSV()">üì§ Exportar CSV</button>
            <input type="file" id="inputFile" accept=".csv" onchange="importarCSV(event)" style="display:none">
            <button class="btn-import" onclick="document.getElementById('inputFile').click()">üì• Importar CSV</button>
            <button class="btn-borrar" onclick="borrarTodo()">üóë Borrar todo</button>
        </div>
        
        <div class="filtros-grid">
            <div class="grupo-filtro"><label>ID Tarea</label><input type="text" id="filtroId" class="input-busqueda" onkeyup="buscar()"></div>
            <div class="grupo-filtro"><label>Fecha</label><input type="text" id="filtroFecha" class="input-busqueda" placeholder="Buscar fecha..." onkeyup="buscar()"></div>
            <div class="grupo-filtro"><label>Zona</label><select id="filtroZona" class="input-busqueda" onchange="buscar()"><option value="">Todas</option></select></div>
            <div class="grupo-filtro"><label>Categor√≠a</label><select id="filtroCateg" class="input-busqueda" onchange="buscar()"><option value="">Todas</option></select></div>
            <div class="grupo-filtro"><label>Estado</label><select id="filtroEstado" class="input-busqueda" onchange="buscar()"><option value="">Todos</option><option value="Pendiente">Pendiente</option><option value="No Reparable">No Reparable</option><option value="En proceso">En proceso</option><option value="Finalizado">Finalizado</option></select></div>
        </div>
    </div>

    <div class="contenedor-tabla">
        <table class="tabla-principal" id="tabla">
            <thead>
                <tr><th>ID</th><th>FECHA</th><th>ZONA</th><th>DETALLE</th><th>LAT</th><th>LON</th><th>ESC</th><th>CATEG</th><th>ESTADO</th><th>CIERRE</th><th>COMENT</th><th>ACCIONES</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const CLIENT_ID = '843149067225-vbnoalp6253li1vpkloj69s1i6nmd48f.apps.googleusercontent.com';
const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.readonly';
const FILE_NAME = 'backup_preventivos_mapa.json';
let tokenClient, accessToken = null;

let db;
let datos = [];
let map;
let markerLayer = L.layerGroup();

const request = indexedDB.open("PreventivasDB", 1);
request.onupgradeneeded = (e) => {
    db = e.target.result;
    if (!db.objectStoreNames.contains("tareas")) db.createObjectStore("tareas", { keyPath: "id_db", autoIncrement: true });
};
request.onsuccess = (e) => {
    db = e.target.result;
    initMap();
    cargarDesdeDB();
    initGoogleAuth();
};

function initMap() {
    map = L.map('mapa-general').setView([-34.6, -58.4], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    markerLayer.addTo(map);
}

function initGoogleAuth() {
    const checkGoogle = setInterval(() => {
        if (typeof google !== 'undefined') {
            clearInterval(checkGoogle);
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (tokenResponse) => {
                    if (tokenResponse.error) return;
                    accessToken = tokenResponse.access_token;
                    sincronizarConDrive();
                },
            });
            console.log("‚úÖ Google Auth Listo");
        }
    }, 500);
}

function handleAuthClick() {
    if (!tokenClient) return alert("Cargando librer√≠a de Google...");
    if (accessToken === null) tokenClient.requestAccessToken({prompt: 'consent'});
    else sincronizarConDrive();
}

async function sincronizarConDrive() {
    const btn = document.getElementById("btnSincronizar");
    btn.innerText = "‚è≥ Sincronizando...";
    try {
        const response = await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${FILE_NAME}' and trashed=false`, {
            headers: { 'Authorization': 'Bearer ' + accessToken }
        });
        const list = await response.json();
        
        if (list.files && list.files.length > 0) {
            const fileId = list.files[0].id;
            const resDl = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                headers: { 'Authorization': 'Bearer ' + accessToken }
            });
            const cloudData = await resDl.json();
            
            const mapLocal = new Map(datos.map(d => [d.ID, d]));
            cloudData.forEach(d => mapLocal.set(d.ID, d));
            datos = Array.from(mapLocal.values());
            
            await actualizarEnDrive(fileId);
        } else {
            await crearEnDrive();
        }
        
        guardarEnDB();
        buscar();
        alert("¬°Sincronizaci√≥n con Drive completada!");
    } catch (err) {
        console.error(err);
        alert("Error al sincronizar con Drive.");
    }
    btn.innerText = "‚òÅÔ∏è Sincronizar Drive";
}

async function actualizarEnDrive(fileId) {
    await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
        method: 'PATCH',
        headers: { 'Authorization': 'Bearer ' + accessToken, 'Content-Type': 'application/json' },
        body: JSON.stringify(datos)
    });
}

async function crearEnDrive() {
    const metadata = { 'name': FILE_NAME, 'mimeType': 'application/json' };
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
    form.append('file', new Blob([JSON.stringify(datos)], {type: 'application/json'}));
    await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
        method: 'POST', headers: { 'Authorization': 'Bearer ' + accessToken }, body: form
    });
}

function cargarDesdeDB() {
    db.transaction("tareas", "readonly").objectStore("tareas").getAll().onsuccess = (e) => {
        datos = e.target.result;
        actualizarSelects();
        buscar();
    };
}

function actualizarSelects() {
    const selZ = document.getElementById("filtroZona");
    const selC = document.getElementById("filtroCateg");
    const zonas = [...new Set(datos.map(d => d.ZONA).filter(z => z))].sort();
    const categs = [...new Set(datos.map(d => d.CATEGORIA).filter(c => c))].sort();
    selZ.innerHTML = '<option value="">Todas</option>' + zonas.map(z => `<option value="${z}">${z}</option>`).join("");
    selC.innerHTML = '<option value="">Todas</option>' + categs.map(c => `<option value="${c}">${c}</option>`).join("");
}

function buscar() {
    const fId = document.getElementById("filtroId").value.toLowerCase();
    const fFecha = document.getElementById("filtroFecha").value.toLowerCase();
    const fZ = document.getElementById("filtroZona").value;
    const fC = document.getElementById("filtroCateg").value;
    const fE = document.getElementById("filtroEstado").value.toLowerCase();

    const filtrados = datos.filter(d => {
        return (String(d.ID).toLowerCase().includes(fId)) &&
               (String(d.FECHA).toLowerCase().includes(fFecha)) &&
               (fZ === "" || d.ZONA === fZ) &&
               (fC === "" || d.CATEGORIA === fC) &&
               (fE === "" || String(d.ESTADO).toLowerCase() === fE);
    });
    render(filtrados);
}

function render(lista) {
    const tbody = document.querySelector("#tabla tbody");
    tbody.innerHTML = "";
    markerLayer.clearLayers();
    let c = { pend: 0, nr: 0, proc: 0, fin: 0 };
    let pZ = {}; let pC = {}; let pM = {}; let bounds = [];
    const meses = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];

    lista.forEach((d) => {
        const est = d.ESTADO || "Pendiente";
        const estL = est.toLowerCase().replace(/\s/g, '');
        
        if(estL === "pendiente") c.pend++;
        else if(estL === "noreparable") c.nr++;
        else if(estL === "enproceso") c.proc++;
        else if(estL === "finalizado") {
            c.fin++;
            if(d.FINALIZACION) {
                const parts = d.FINALIZACION.split(/[-/]/);
                if(parts.length===3) {
                    const m = parseInt(parts[1])-1;
                    const a = parts[2].length===2 ? "20"+parts[2] : parts[2];
                    if(m>=0 && m<12) pM[`${meses[m]} ${a}`] = (pM[`${meses[m]} ${a}`] || 0) + 1;
                }
            }
        }

        pZ[d.ZONA || "S/Z"] = (pZ[d.ZONA || "S/Z"] || 0) + 1;
        pC[d.CATEGORIA || "S/C"] = (pC[d.CATEGORIA || "S/C"] || 0) + 1;

        const lat = parseFloat(String(d.LATITUD).replace(",","."));
        const lon = parseFloat(String(d.LONGITUD).replace(",","."));
        if(!isNaN(lat) && !isNaN(lon)) {
            const color = estL==="pendiente"?"#dc3545":estL==="enproceso"?"#007bff":estL==="finalizado"?"#28a745":"#6c757d";
            const m = L.circleMarker([lat, lon], { radius: 8, fillColor: color, color: "#fff", weight: 2, fillOpacity: 1 });
            m.bindTooltip(`${d.ID}`, { permanent: true, className: 'etiqueta-id', offset: [0,-8] });
            markerLayer.addLayer(m);
            bounds.push([lat, lon]);
        }

        const realIdx = datos.findIndex(orig => orig === d);
        const tr = document.createElement("tr");
        tr.className = `estado-${estL}`;
        tr.innerHTML = `
            <td contenteditable onblur="saveCell(${realIdx},'ID',this)">${d.ID||""}</td>
            <td contenteditable onblur="saveCell(${realIdx},'FECHA',this)">${d.FECHA||""}</td>
            <td contenteditable onblur="saveCell(${realIdx},'ZONA',this)">${d.ZONA||""}</td>
            <td contenteditable onblur="saveCell(${realIdx},'DETALLE',this)">${d.DETALLE||""}</td>
            <td contenteditable onblur="saveCell(${realIdx},'LATITUD',this)">${d.LATITUD||""}</td>
            <td contenteditable onblur="saveCell(${realIdx},'LONGITUD',this)">${d.LONGITUD||""}</td>
            <td contenteditable onblur="saveCell(${realIdx},'ESCALERA',this)">${d.ESCALERA||""}</td>
            <td contenteditable onblur="saveCell(${realIdx},'CATEGORIA',this)">${d.CATEGORIA||""}</td>
            <td><select onchange="cambiarEstado(${realIdx},this.value)">${["Pendiente","No Reparable","En proceso","Finalizado"].map(e=>`<option ${est===e?"selected":""}>${e}</option>`).join("")}</select></td>
            <td contenteditable onblur="saveCell(${realIdx},'FINALIZACION',this)">${d.FINALIZACION||""}</td>
            <td contenteditable onblur="saveCell(${realIdx},'COMENTARIO',this)">${d.COMENTARIO||""}</td>
            <td>
                <button onclick="zoomTo(${lat},${lon})" style="background:#6c757d; padding: 4px 8px;">üìç</button>
                <button onclick="borrarFila(${realIdx})" style="background:#dc3545; padding: 4px 8px;">‚ùå</button>
            </td>
        `;
        tbody.appendChild(tr);
    });

    document.getElementById("res-total").innerText = lista.length;
    document.getElementById("res-pend").innerText = c.pend;
    document.getElementById("res-nr").innerText = c.nr;
    document.getElementById("res-proc").innerText = c.proc;
    document.getElementById("res-fin").innerText = c.fin;
    actualizarBox("stats-zona", pZ); actualizarBox("stats-categoria", pC); actualizarBox("stats-mes", pM, false);
    
    if(bounds.length > 0) map.fitBounds(bounds, { padding: [30, 30] });
}

function saveCell(idx, campo, cell) { datos[idx][campo] = cell.innerText.trim(); guardarEnDB(); }
function cambiarEstado(idx, val) { datos[idx].ESTADO = val; guardarEnDB(); buscar(); }
function actualizarBox(id, obj, s=true) {
    const box = document.getElementById(id);
    let items = Object.entries(obj); if(s) items.sort((a,b)=>b[1]-a[1]);
    box.innerHTML = items.length ? '<table class="stats-table">' + items.map(([k,v])=>`<tr><td>${k}</td><td>${v}</td></tr>`).join("") + '</table>' : '<small>Sin datos</small>';
}
function zoomTo(la, lo) { if(!isNaN(la)) map.setView([la, lo], 18); }
function guardarEnDB() {
    const tx = db.transaction("tareas", "readwrite");
    const store = tx.objectStore("tareas");
    store.clear().onsuccess = () => { datos.forEach(d => { const c = {...d}; delete c.id_db; store.add(c); }); };
}
function agregarFila() { datos.unshift({ ID: "NUEVO", FECHA: new Date().toLocaleDateString(), ESTADO: "Pendiente" }); buscar(); guardarEnDB(); }

function borrarFila(idx) {
    if(confirm("¬øEst√°s seguro de eliminar esta tarea?")) {
        datos.splice(idx, 1);
        guardarEnDB();
        buscar();
    }
}

function borrarTodo() { if(confirm("¬øBorrar todo?")) { datos = []; guardarEnDB(); buscar(); } }

function importarCSV(e) {
    const reader = new FileReader();
    reader.onload = () => {
        const lineas = reader.result.split(/\r?\n/);
        const sep = lineas[0].includes(";") ? ";" : ",";
        lineas.shift();
        lineas.forEach(l => {
            if(!l.trim()) return;
            const c = l.split(sep).map(v => v.replace(/"/g,'').trim());
            datos.push({ ID:c[0], FECHA:c[1], ZONA:c[2], DETALLE:c[3], LATITUD:c[4], LONGITUD:c[5], ESCALERA:c[6], CATEGORIA:c[7], ESTADO:c[8]||"Pendiente", FINALIZACION:c[9], COMENTARIO:c[10] });
        });
        guardarEnDB(); buscar();
    };
    reader.readAsText(e.target.files[0], "ISO-8859-1");
}

function exportarCSV() {
    let csv = "ID,FECHA,ZONA,DETALLE,LATITUD,LONGITUD,ESCALERA,CATEGORIA,ESTADO,FINALIZACION,COMENTARIO\n";
    datos.forEach(d => csv += [d.ID, d.FECHA, d.ZONA, d.DETALLE, d.LATITUD, d.LONGITUD, d.ESCALERA, d.CATEGORIA, d.ESTADO, d.FINALIZACION, d.COMENTARIO].map(v => `"${v||""}"`).join(",") + "\n");
    const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([csv], {type:"text/csv"})); a.download = "preventivos.csv"; a.click();
}
</script>
</body>
</html>