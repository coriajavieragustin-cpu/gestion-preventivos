<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gesti√≥n Preventivos - Diferenciaci√≥n Mejorada</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin:15px; background-color: #f0f2f5; }
        .header-app { display: flex; align-items: center; background: #fff; padding: 10px 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 10px; gap: 15px; }
        
        /* ESTADOS - DIFERENCIACI√ìN VISUAL FUERTE */
        .estado-pendiente { background-color: #fff5f5 !important; border-left: 5px solid #dc3545 !important; }
        .estado-enproceso { background-color: #f0f7ff !important; border-left: 5px solid #007bff !important; }
        .estado-finalizado { background-color: #f2fff5 !important; border-left: 5px solid #28a745 !important; }

        .status-bar { display: flex; justify-content: space-between; padding: 8px 20px; background: #fff; border-radius: 8px; margin-bottom: 10px; font-size: 12px; font-weight: bold; border-left: 5px solid #ccc; }
        .status-ok { border-left-color: #28a745; color: #28a745; }
        
        .panel-central { display: grid; grid-template-columns: 1.6fr 1fr; gap: 15px; margin-bottom: 15px; height: 450px; }
        #mapa-general { height: 100%; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        .stats-box { background: #fff; padding: 12px; border-radius: 8px; flex: 1; overflow-y: auto; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stats-table { width: 100%; font-size: 11px; border-collapse: collapse; }
        .stats-table td { padding: 4px 0; border-bottom: 1px dotted #eee; }

        .controles { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .filtros-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; background: #f8f9fa; padding: 15px; border-radius: 8px; }
        .input-busqueda { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }

        button { padding: 10px 16px; border: none; border-radius: 6px; color: white; cursor: pointer; font-weight: bold; font-size: 12px; }
        .btn-drive { background: #1fa463; }
        .btn-export { background: #17a2b8; }
        .btn-import { background: #ffc107; color: #333; }

        .contenedor-tabla { background: #fff; border-radius: 8px; overflow: auto; max-height: 500px; }
        table { width: 100%; border-collapse: collapse; min-width: 1300px; font-size: 11px; }
        th { position: sticky; top: 0; background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; z-index: 10; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

    <div class="header-app">
        <h2>GESTI√ìN PREVENTIVOS V1.1</h2>
    </div>

    <div id="statusBar" class="status-bar">
        <span id="statusText">Listo para sincronizar</span>
        <span id="statusTime">--:--:--</span>
    </div>

    <div class="panel-central">
        <div id="mapa-general"></div>
        <div style="display: flex; flex-direction: column; height: 100%;">
            <div class="stats-box"><h3>üìç Top Zonas</h3><div id="stats-zona"></div></div>
            <div class="stats-box"><h3>üè∑Ô∏è Categor√≠as</h3><div id="stats-categoria"></div></div>
        </div>
    </div>

    <div class="controles">
        <div style="margin-bottom: 15px; display: flex; gap: 10px;">
            <button class="btn-drive" onclick="cargarDesdeGoogleSheets()">üîÑ Sincronizar Drive</button>
            <button class="btn-export" onclick="exportarCSV()">üì• Exportar CSV</button>
            <button class="btn-import" onclick="document.getElementById('inputImport').click()">üì§ Importar Local</button>
            <input type="file" id="inputImport" accept=".csv" style="display:none" onchange="importarCSV(event)">
        </div>
        
        <div class="filtros-grid">
            <div class="grupo-filtro"><label>ID</label><input type="text" id="fId" class="input-busqueda" onkeyup="buscar()"></div>
            <div class="grupo-filtro"><label>Zona</label><select id="fZon" class="input-busqueda" onchange="buscar()"><option value="">Todas</option></select></div>
            <div class="grupo-filtro">
                <label>Estado</label>
                <select id="fEst" class="input-busqueda" onchange="buscar()">
                    <option value="">Todos</option>
                    <option value="Pendiente">Pendiente</option>
                    <option value="En proceso">En proceso</option>
                    <option value="Finalizado">Finalizado</option>
                </select>
            </div>
        </div>
    </div>

    <div class="contenedor-tabla">
        <table id="tabla">
            <thead>
                <tr><th>ID</th><th>FECHA</th><th>ZONA</th><th>DETALLE</th><th>LAT</th><th>LON</th><th>ESC</th><th>CATEG</th><th>ESTADO</th><th>ACCIONES</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSMvIGwGPgfBWm-SWC3aJDtBmAeJdI8frsSsOqcpKn7j_NjYHhCfXH_0OxBTCiY_L7vmrON2g6RIbnc/pub?gid=579969097&single=true&output=csv";
        let datos = [];
        let map = L.map('mapa-general').setView([-27.46, -58.83], 12);
        let markerLayer = L.layerGroup().addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        function limpiarCoordenada(valor) {
            if (!valor) return NaN;
            let soloNumeros = valor.toString().replace(/[^0-9]/g, '');
            if (soloNumeros.length < 5) return NaN;
            
            // Forzamos Corrientes: -27.xxxx y -58.xxxx
            let prefijo = soloNumeros.substring(0, 2);
            let resto = soloNumeros.substring(2);
            return parseFloat("-" + prefijo + "." + resto);
        }

        async function cargarDesdeGoogleSheets() {
            try {
                const resp = await fetch(SHEET_URL + "&cb=" + Date.now());
                const texto = await resp.text();
                procesarCSV(texto);
                document.getElementById("statusBar").className = "status-bar status-ok";
                document.getElementById("statusText").innerText = "‚úÖ Sincronizado";
                document.getElementById("statusTime").innerText = new Date().toLocaleTimeString();
            } catch (e) { alert("Error al conectar con Drive"); }
        }

        function procesarCSV(texto) {
            const lineas = texto.split(/\r?\n/);
            datos = [];
            for(let i = 1; i < lineas.length; i++) {
                if(!lineas[i].trim()) continue;
                // Separador inteligente para no romper con las comas de "Detalle"
                const c = lineas[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.replace(/^"|"$/g, '').trim());
                if(c.length < 9) continue;
                datos.push({
                    ID: c[0], FECHA: c[1], ZONA: c[2], DETALLE: c[3],
                    LAT: c[4], LON: c[5], ESC: c[6], CAT: c[7],
                    ESTADO: c[8] || "Pendiente"
                });
            }
            actualizarSelects();
            buscar();
        }

        function buscar() {
            const valId = document.getElementById("fId").value.toLowerCase();
            const valZon = document.getElementById("fZon").value;
            const valEst = document.getElementById("fEst").value.toLowerCase();

            const filtrados = datos.filter(d => {
                const coincideId = d.ID.toLowerCase().includes(valId);
                const coincideZon = valZon === "" || d.ZONA === valZon;
                // El filtro ahora es m√°s flexible con espacios
                const coincideEst = valEst === "" || d.ESTADO.toLowerCase().trim().includes(valEst);
                return coincideId && coincideZon && coincideEst;
            });
            render(filtrados);
        }

        function render(lista) {
            const tbody = document.querySelector("#tabla tbody");
            tbody.innerHTML = "";
            markerLayer.clearLayers();
            let pZ = {}; let pC = {}; let bounds = [];

            lista.forEach((d, idx) => {
                const estNormal = d.ESTADO.toLowerCase().trim();
                const claseEstado = estNormal.includes("pend") ? "estado-pendiente" : 
                                   estNormal.includes("proc") ? "estado-enproceso" : "estado-finalizado";

                pZ[d.ZONA] = (pZ[d.ZONA] || 0) + 1;
                pC[d.CAT] = (pC[d.CAT] || 0) + 1;

                let lat = limpiarCoordenada(d.LAT);
                let lon = limpiarCoordenada(d.LON);
                if(!isNaN(lat)) {
                    const col = estNormal.includes("pend") ? "red" : estNormal.includes("proc") ? "blue" : "green";
                    L.circleMarker([lat, lon], { radius: 7, fillColor: col, color: "#fff", weight: 2, fillOpacity: 0.9 })
                     .addTo(markerLayer).bindPopup(`ID: ${d.ID}`);
                    bounds.push([lat, lon]);
                }

                const tr = document.createElement("tr");
                tr.className = claseEstado;
                tr.innerHTML = `
                    <td><b>${d.ID}</b></td><td>${d.FECHA}</td><td>${d.ZONA}</td>
                    <td style="max-width:300px;">${d.DETALLE}</td>
                    <td>${d.LAT}</td><td>${d.LON}</td><td>${d.ESC}</td><td>${d.CAT}</td>
                    <td><span style="font-weight:bold">${d.ESTADO}</span></td>
                    <td><button onclick="map.setView([${lat},${lon}],18)" style="background:#666; padding:5px;">üìç</button></td>
                `;
                tbody.appendChild(tr);
            });
            actualizarBox("stats-zona", pZ); actualizarBox("stats-categoria", pC);
            if(bounds.length > 0) map.fitBounds(bounds);
        }

        function actualizarBox(id, obj) {
            const items = Object.entries(obj).sort((a,b)=>b[1]-a[1]);
            document.getElementById(id).innerHTML = '<table class="stats-table">' + items.map(([k,v])=>`<tr><td>${k}</td><td style="text-align:right"><b>${v}</b></td></tr>`).join("") + '</table>';
        }

        function actualizarSelects() {
            const zs = [...new Set(datos.map(d => d.ZONA))].sort();
            document.getElementById("fZon").innerHTML = '<option value="">Todas</option>' + zs.map(z=>`<option>${z}</option>`).join("");
        }

        function exportarCSV() { /* l√≥gica de exportar */ }
        function importarCSV(e) { /* l√≥gica de importar */ }

        window.onload = cargarDesdeGoogleSheets;
    </script>
</body>
</html>
