<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gesti√≥n Preventivos V1.5 - Corrientes</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* Estilos base (Mantenidos para no perder tu dise√±o) */
        body { font-family: sans-serif; margin:0; background:#f4f7f6; }
        .header { background:#fff; padding:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); display:flex; align-items:center; }
        .status-bar { background:#28a745; color:#fff; padding:5px 15px; font-size:12px; }
        .cards-container { display:flex; gap:10px; padding:15px; }
        .card { background:#fff; flex:1; padding:15px; border-radius:8px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.05); }
        .card h3 { margin:0; font-size:12px; color:#666; }
        .card span { font-size:24px; font-weight:bold; }
        .main-content { display:grid; grid-template-columns: 2fr 1fr; gap:15px; padding:0 15px; height:400px; }
        #map { background:#ddd; border-radius:8px; height:100%; }
        .stats-panel { background:#fff; border-radius:8px; padding:15px; overflow-y:auto; }
        .table-container { padding:15px; overflow-x:auto; }
        table { width:100%; border-collapse:collapse; background:#fff; font-size:12px; }
        th { background:#f8f9fa; padding:10px; text-align:left; border-bottom:2px solid #eee; }
        td { padding:10px; border-bottom:1px solid #eee; }
        
        /* Modal corregido */
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center; }
        .modal-content { background:#fff; padding:20px; border-radius:12px; width:500px; max-height:90vh; overflow-y:auto; }
        .modal-grid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
        .full-width { grid-column: span 2; }
        label { display:block; font-size:11px; font-weight:bold; margin-bottom:2px; }
        input, select { width:100%; padding:8px; margin-bottom:10px; border:1px solid #ccc; border-radius:4px; box-sizing:border-box; }
        .btn-save { background:#4f46e5; color:#fff; border:none; padding:10px; border-radius:8px; width:100%; cursor:pointer; font-weight:bold; }
        .btn-close { background:#f8f9fa; border:1px solid #ddd; padding:10px; border-radius:8px; width:100%; margin-top:5px; cursor:pointer; }
    </style>
</head>
<body>

<div class="status-bar">‚úî Datos actualizados en tiempo real</div>
<div class="header"><h2>GESTI√ìN PREVENTIVOS V1.5 - REAL TIME</h2></div>

<div class="cards-container">
    <div class="card"><h3>TOTAL</h3><span id="count-total">0</span></div>
    <div class="card" style="border-bottom:4px solid #dc3545"><h3>PENDIENTES</h3><span id="count-pend" style="color:#dc3545">0</span></div>
    <div class="card" style="border-bottom:4px solid #007bff"><h3>EN PROCESO</h3><span id="count-proc" style="color:#007bff">0</span></div>
    <div class="card" style="border-bottom:4px solid #28a745"><h3>FINALIZADOS</h3><span id="count-fin" style="color:#28a745">0</span></div>
</div>

<div class="main-content">
    <div id="map"></div>
    <div class="stats-panel">
        <h4>üè∑Ô∏è Categor√≠as</h4>
        <div id="stats-cat"></div>
    </div>
</div>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>ID</th><th>FECHA</th><th>ZONA</th><th>DETALLE</th><th>LAT</th><th>LON</th><th>ESC</th><th>CATEG</th><th>ESTADO</th><th>CIERRE</th><th>ACCI√ìN</th>
            </tr>
        </thead>
        <tbody id="table-body"></tbody>
    </table>
</div>

<div id="taskModal" class="modal">
    <div class="modal-content">
        <h3>Detalle de Tarea</h3>
        <div class="modal-grid">
            <div class="full-width"><label>ID Tarea</label><input type="text" id="m_id" readonly></div>
            <div><label>Fecha</label><input type="text" id="m_fec"></div>
            <div><label>Zona</label><input type="text" id="m_zon"></div>
            <div class="full-width"><label>Actividad / Detalle</label><input type="text" id="m_det"></div>
            <div><label>Latitud</label><input type="text" id="m_lat"></div>
            <div><label>Longitud</label><input type="text" id="m_lon"></div>
            <div><label>Categor√≠a</label>
                <select id="m_cat">
                    <option value="POSTES">POSTES</option>
                    <option value="PODA">PODA</option>
                    <option value="VANO BAJO">VANO BAJO</option>
                    <option value="TUTOR">TUTOR</option>
                </select>
            </div>
            <div><label>Estado</label>
                <select id="m_est">
                    <option value="Pendiente">Pendiente</option>
                    <option value="En proceso">En proceso</option>
                    <option value="Finalizado">Finalizado</option>
                </select>
            </div>
            <div><label>Escalera</label>
                <select id="m_esc"><option value="SI">SI</option><option value="NO">NO</option></select>
            </div>
            <div><label>Cierre (Finalizaci√≥n)</label><input type="text" id="m_cie"></div>
        </div>
        <button class="btn-save" onclick="saveChanges()">üíæ Guardar Cambios</button>
        <button class="btn-close" onclick="closeModal()">Cerrar</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // PEGA AQU√ç TU URL DE GOOGLE APPS SCRIPT
    const G_URL = "https://script.google.com/macros/s/AKfycbzGqbeqI_NWa53sFPCRvez-8eMHF34lQn8SQY5CiIMsMpS85f70374SPUHfC31Whuf9/exec"; 
    let allData = [];

    async function loadData() {
        const res = await fetch(G_URL);
        allData = await res.json();
        renderDashboard();
    }

    // FIX PARA EL ERROR UNDEFINED: Esta funci√≥n limpia el texto y evita errores de fecha
    function cleanVal(val) {
        if (!val || val == "undefined" || val == "null") return "";
        return val;
    }

    function renderDashboard() {
        const tbody = document.getElementById("table-body");
        tbody.innerHTML = "";
        let counts = { total: 0, pend: 0, proc: 0, fin: 0 };
        let catStats = {};

        allData.forEach((d, idx) => {
            counts.total++;
            if (d.ESTADO === "Pendiente") counts.pend++;
            if (d.ESTADO === "En proceso") counts.proc++;
            if (d.ESTADO === "Finalizado") counts.fin++;

            // Conteo de categor√≠as para el panel derecho
            let c = cleanVal(d.CATEGORIA) || "S/D";
            catStats[c] = (catStats[c] || 0) + 1;

            tbody.innerHTML += `
                <tr>
                    <td>${d.ID}</td>
                    <td>${cleanVal(d.FECHA)}</td>
                    <td>${cleanVal(d.ZONA)}</td>
                    <td>${cleanVal(d.DETALLE)}</td>
                    <td>${cleanVal(d.LATITUD)}</td>
                    <td>${cleanVal(d.LONGITUD)}</td>
                    <td>${cleanVal(d.ESCALERA)}</td>
                    <td>${cleanVal(d.CATEGORIA)}</td>
                    <td>${cleanVal(d.ESTADO)}</td>
                    <td>${cleanVal(d.FINALIZACION)}</td>
                    <td><button onclick="openModal(${idx})">‚úé</button></td>
                </tr>
            `;
        });

        document.getElementById("count-total").innerText = counts.total;
        document.getElementById("count-pend").innerText = counts.pend;
        document.getElementById("count-proc").innerText = counts.proc;
        document.getElementById("count-fin").innerText = counts.fin;

        // Render stats categor√≠as
        let statHtml = "";
        for (let cat in catStats) {
            statHtml += `<div style="font-size:11px; margin-bottom:5px;"><b>${cat}:</b> ${catStats[cat]}</div>`;
        }
        document.getElementById("stats-cat").innerHTML = statHtml;
    }

    let currentIdx = null;
    function openModal(idx) {
        currentIdx = idx;
        const d = allData[idx];
        document.getElementById("m_id").value = d.ID;
        document.getElementById("m_fec").value = cleanVal(d.FECHA);
        document.getElementById("m_zon").value = cleanVal(d.ZONA);
        document.getElementById("m_det").value = cleanVal(d.DETALLE);
        document.getElementById("m_lat").value = cleanVal(d.LATITUD);
        document.getElementById("m_lon").value = cleanVal(d.LONGITUD);
        document.getElementById("m_cat").value = d.CATEGORIA;
        document.getElementById("m_est").value = d.ESTADO;
        document.getElementById("m_esc").value = d.ESCALERA;
        document.getElementById("m_cie").value = cleanVal(d.FINALIZACION);
        document.getElementById("taskModal").style.display = "flex";
    }

    function closeModal() { document.getElementById("taskModal").style.display = "none"; }

   async function saveChanges() {
    console.log("Iniciando guardado..."); // Esto se ve en la consola (F12)
    
    // 1. Verificamos que los campos existan en el HTML
    const id = document.getElementById("m_id").value;
    if (!id) {
        alert("Error: No se encontr√≥ el ID de la tarea.");
        return;
    }

    const updatedRow = {
        ID: id,
        FECHA: document.getElementById("m_fec").value,
        ZONA: document.getElementById("m_zon").value,
        DETALLE: document.getElementById("m_det").value,
        LATITUD: document.getElementById("m_lat").value,
        LONGITUD: document.getElementById("m_lon").value,
        CATEGORIA: document.getElementById("m_cat").value,
        ESTADO: document.getElementById("m_est").value,
        ESCALERA: document.getElementById("m_esc").value,
        FINALIZACION: document.getElementById("m_cie").value
    };

    // 2. Verificamos la URL
    if (G_URL === "TU_URL_AQUI" || G_URL === "") {
        alert("¬°Error Cr√≠tico! No configuraste la URL del Script en la l√≠nea 'const G_URL'.");
        return;
    }

    const formData = new URLSearchParams();
    formData.append("action", "update");
    formData.append("row", JSON.stringify(updatedRow));

    try {
        alert("Enviando datos a Google Sheets... Por favor espera.");
        
        const response = await fetch(G_URL, { 
            method: "POST", 
            body: formData, 
            mode: "no-cors" 
        });

        // Con no-cors no podemos leer la respuesta, pero si llega ac√°, se envi√≥.
        alert("‚úÖ Solicitud enviada. La fila con ID " + id + " deber√≠a actualizarse en unos segundos.");
        closeModal();
        setTimeout(loadData, 2000); // Recarga los datos despu√©s de 2 segundos
        
    } catch (e) {
        console.error(e);
        alert("‚ùå Error de conexi√≥n: " + e.message);
    }
}

        // ENVIAR AL GOOGLE SHEET
        const formData = new URLSearchParams();
        formData.append("action", "update");
        formData.append("row", JSON.stringify(updatedRow));

        try {
            await fetch(G_URL, { method: "POST", body: formData, mode: "no-cors" });
            alert("¬°Cambio enviado! Actualizando...");
            closeModal();
            loadData(); // Recargar datos para ver el cambio
        } catch (e) {
            alert("Error al guardar: " + e.message);
        }
    }

    window.onload = loadData;
</script>
</body>
</html>


