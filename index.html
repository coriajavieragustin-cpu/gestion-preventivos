<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gesti칩n Preventivos V1.5 - Fix Layout</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --pend: #dc3545; --norep: #6c757d; --proc: #007bff; --fin: #28a745; }
        
        /* Reset b치sico para evitar saltos de l칤nea extra침os */
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f4f7f6; display: flex; flex-direction: column; height: 100vh; }

        /* Contenedor Superior (Fijo) */
        .top-panel { background: white; padding: 10px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 1000; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        
        .resumen { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 10px; }
        .card { background: #f8f9fa; padding: 8px; border-radius: 6px; text-align: center; border-top: 3px solid #ccc; font-size: 11px; }
        .card span { display: block; font-size: 18px; font-weight: bold; }

        /* 츼rea Central (Mapa y Stats) */
        .main-content { display: flex; flex: 1; min-height: 400px; gap: 10px; padding: 10px; overflow: hidden; }
        #map { flex: 2; border-radius: 8px; border: 1px solid #ddd; z-index: 1; } /* Z-index bajo para que no tape men칰s */
        .side-stats { flex: 1; background: white; border-radius: 8px; padding: 15px; overflow-y: auto; border: 1px solid #ddd; }

        /* Panel de Control (Filtros) */
        .control-panel { background: #e9ecef; padding: 15px; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; }
        .filtros-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        
        /* Tabla (Secci칩n inferior con scroll propio) */
        .table-container { flex: 1; overflow: auto; background: white; padding: 0 10px 10px 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; min-width: 1000px; }
        th { position: sticky; top: 0; background: #343a40; color: white; padding: 10px; text-align: left; z-index: 10; }
        td { padding: 8px; border-bottom: 1px solid #eee; }

        /* Clases de estado */
        .fila-pendiente { border-left: 5px solid var(--pend); background: #fff5f5; }
        .fila-finalizado { border-left: 5px solid var(--fin); background: #f2fff5; }
        .btn { cursor: pointer; padding: 6px 12px; border: none; border-radius: 4px; color: white; font-weight: bold; }
    </style>
</head>
<body>

    <div class="top-panel">
        <div class="header">
            <h2 style="margin:0; color:#1a73e8;">SISTEMA DE GESTI칍N V1.5</h2>
            <div id="reloj">Cargando datos...</div>
        </div>
        <div class="resumen">
            <div class="card" style="border-color:#333">TOTAL <span id="t-total">0</span></div>
            <div class="card" style="border-color:var(--pend)">PENDIENTES <span id="t-pend">0</span></div>
            <div class="card" style="border-color:var(--norep)">NO REPARABLES <span id="t-norep">0</span></div>
            <div class="card" style="border-color:var(--fin)">FINALIZADOS <span id="t-fin">0</span></div>
        </div>
    </div>

    <div class="main-content">
        <div id="map"></div>
        <div class="side-stats">
            <h4 style="margin-top:0">Estad칤sticas por Zona</h4>
            <div id="lista-zonas"></div>
            <hr>
            <h4>Categor칤as</h4>
            <div id="lista-cats"></div>
        </div>
    </div>

    <div class="control-panel">
        <div class="filtros-grid">
            <div>
                <label style="font-size:10px; font-weight:bold;">BUSCAR ID</label>
                <input type="text" id="f-id" onkeyup="buscar()" style="width:100%; padding:5px;">
            </div>
            <div>
                <label style="font-size:10px; font-weight:bold;">ESTADO</label>
                <select id="f-estado" onchange="buscar()" style="width:100%; padding:5px;">
                    <option value="">Todos</option>
                    <option value="pendiente">Pendiente</option>
                    <option value="no reparable">No Reparable</option>
                    <option value="finalizado">Finalizado</option>
                </select>
            </div>
            <div style="display:flex; align-items:flex-end; gap:5px;">
                <button class="btn" style="background:#28a745" onclick="cargarDrive()">Sincronizar</button>
                <button class="btn" style="background:#17a2b8" onclick="exportar()">Exportar</button>
            </div>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>ID</th><th>FECHA</th><th>ZONA</th><th>DETALLE</th>
                    <th>LAT</th><th>LON</th><th>ESTADO</th><th>ACCI칍N</th>
                </tr>
            </thead>
            <tbody id="cuerpo-tabla"></tbody>
        </table>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const URL_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSMvIGwGPgfBWm-SWC3aJDtBmAeJdI8frsSsOqcpKn7j_NjYHhCfXH_0OxBTCiY_L7vmrON2g6RIbnc/pub?gid=579969097&single=true&output=csv";
        let datos = [];
        let map = L.map('map').setView([-27.46, -58.83], 12);
        let markers = L.layerGroup().addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // Funci칩n corregida para tus coordenadas con comas de miles
        function limpiarCoord(v) {
            if(!v) return NaN;
            let n = v.toString().replace(/[^0-9-]/g, '');
            return parseFloat(n.substring(0,3) + "." + n.substring(3));
        }

        async function cargarDrive() {
            try {
                const r = await fetch(URL_CSV + "?cb=" + Date.now());
                const csv = await r.text();
                const filas = csv.split(/\r?\n/);
                datos = [];
                for(let i=1; i<filas.length; i++){
                    const c = filas[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.replace(/^"|"$/g, '').trim());
                    if(c.length < 8) continue;
                    datos.push({ id:c[0], fec:c[1], zon:c[2], det:c[3], lat:c[4], lon:c[5], est:c[8] });
                }
                buscar();
                document.getElementById("reloj").innerText = "Sincronizado: " + new Date().toLocaleTimeString();
                setTimeout(() => map.invalidateSize(), 200);
            } catch(e) { console.log(e); }
        }

        function buscar() {
            const idBusq = document.getElementById("f-id").value.toLowerCase();
            const estBusq = document.getElementById("f-estado").value.toLowerCase();
            
            const filtrados = datos.filter(d => 
                d.id.toLowerCase().includes(idBusq) && 
                (estBusq === "" || d.est.toLowerCase().includes(estBusq))
            );
            renderizar(filtrados);
        }

        function renderizar(lista) {
            const tbody = document.getElementById("cuerpo-tabla");
            tbody.innerHTML = "";
            markers.clearLayers();
            let c = { t:0, p:0, n:0, f:0 };
            let bounds = [];

            lista.forEach(d => {
                c.t++;
                let est = d.est.toLowerCase();
                let clase = ""; let color = "gray";

                if(est.includes("pend")) { clase="fila-pendiente"; color="red"; c.p++; }
                else if(est.includes("reparable")) { color="orange"; c.n++; }
                else if(est.includes("fin")) { clase="fila-finalizado"; color="green"; c.f++; }

                let lt = limpiarCoord(d.lat);
                let ln = limpiarCoord(d.lon);

                if(!isNaN(lt)) {
                    L.circleMarker([lt, ln], {radius:6, color:color, fillOpacity:0.8}).addTo(markers);
                    bounds.push([lt, ln]);
                }

                tbody.innerHTML += `
                    <tr class="${clase}">
                        <td>${d.id}</td><td>${d.fec}</td><td>${d.zon}</td>
                        <td title="${d.det}">${d.det.substring(0,30)}...</td>
                        <td>${lt.toFixed(4)}</td><td>${ln.toFixed(4)}</td>
                        <td><b>${d.est}</b></td>
                        <td><button onclick="map.setView([${lt},${ln}],18)">游늸</button></td>
                    </tr>`;
            });

            document.getElementById("t-total").innerText = c.t;
            document.getElementById("t-pend").innerText = c.p;
            document.getElementById("t-norep").innerText = c.n;
            document.getElementById("t-fin").innerText = c.f;
            if(bounds.length > 0) map.fitBounds(bounds);
        }

        window.onload = cargarDrive;
    </script>
</body>
</html>

