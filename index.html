<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel Preventivos - Anti Solapamiento</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin:15px; background: #f0f2f5; }
        .header-app { display: flex; align-items: center; background: #fff; padding: 10px 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
        #mapa-general { height: 500px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .resumen-estados { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 15px; }
        .card-conteo { padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; background: #fff; font-size: 11px; border-top: 4px solid #333; }
        .card-conteo span { display: block; font-size: 20px; }
        
        /* Botonera */
        .controles { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        button { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; margin-right: 5px; }
        .btn-drive { background: #1fa463; color: white; }
        .btn-import { background: #ffc107; }
        
        .contenedor-tabla { background: #fff; border-radius: 8px; overflow: auto; max-height: 400px; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; min-width: 1000px; }
        th { background: #f8f9fa; position: sticky; top: 0; padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6; }
        td { padding: 8px; border-bottom: 1px solid #eee; }
        
        /* Estilo para los labels del mapa */
        .etiqueta-id { background: rgba(0,0,0,0.7); color: white; border: none; padding: 1px 4px; border-radius: 3px; font-size: 9px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header-app"><h2>GESTI√ìN PREVENTIVOS - VISTA DISPERSA</h2></div>

    <div class="resumen-estados">
        <div class="card-conteo" style="border-color: #333">TOTAL <span id="res-total">0</span></div>
        <div class="card-conteo" style="border-color: #dc3545">PENDIENTES <span id="res-pend">0</span></div>
        <div class="card-conteo" style="border-color: #007bff">EN PROCESO <span id="res-proc">0</span></div>
        <div class="card-conteo" style="border-color: #28a745">FINALIZADOS <span id="res-fin">0</span></div>
        <div class="card-conteo" style="border-color: #6c757d">OTROS <span id="res-nr">0</span></div>
    </div>

    <div id="mapa-general"></div>

    <div class="controles">
        <button class="btn-drive" onclick="cargarDesdeGoogleSheets()">Sincronizar Drive</button>
        <button class="btn-import" onclick="document.getElementById('inputFile').click()">Importar CSV Local</button>
        <input type="file" id="inputFile" style="display:none" onchange="importarLocal(event)">
    </div>

    <div class="contenedor-tabla">
        <table id="tabla-datos">
            <thead>
                <tr><th>ID</th><th>ZONA</th><th>DETALLE</th><th>LAT</th><th>LON</th><th>ESTADO</th><th>ACCIONES</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const URL_SHEET = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSMvIGwGPgfBWm-SWC3aJDtBmAeJdI8frsSsOqcpKn7j_NjYHhCfXH_0OxBTCiY_L7vmrON2g6RIbnc/pub?gid=579969097&single=true&output=csv";
        let map, markerLayer;
        let datos = [];

        window.onload = () => {
            map = L.map('mapa-general').setView([-27.46, -58.83], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            markerLayer = L.layerGroup().addTo(map);
            cargarDesdeGoogleSheets();
        };

        async function cargarDesdeGoogleSheets() {
            try {
                const r = await fetch(URL_SHEET + "&nocache=" + Date.now());
                const texto = await r.text();
                procesarTexto(texto);
            } catch(e) { alert("Error al conectar con Drive"); }
        }

        function importarLocal(e) {
            const reader = new FileReader();
            reader.onload = () => procesarTexto(reader.result);
            reader.readAsText(e.target.files[0], "ISO-8859-1");
        }

        function procesarTexto(texto) {
            const lineas = texto.split(/\r?\n/);
            const sep = lineas[0].includes(";") ? ";" : ",";
            datos = [];
            
            for(let i = 1; i < lineas.length; i++) {
                if(!lineas[i].trim()) continue;
                const c = lineas[i].split(sep).map(v => v.replace(/"/g,'').trim());
                if(c.length < 6) continue;
                
                datos.push({
                    ID: c[0], ZONA: c[2], DETALLE: c[3],
                    LAT: parseFloat((c[4]||"").replace(',','.')),
                    LON: parseFloat((c[5]||"").replace(',','.')),
                    ESTADO: c[8] || "Pendiente"
                });
            }
            render();
        }

        function render() {
            markerLayer.clearLayers();
            const tbody = document.querySelector("#tabla-datos tbody");
            tbody.innerHTML = "";
            let counts = { tot:0, p:0, ep:0, f:0, o:0 };
            let coordsUsadas = {}; // Para detectar duplicados de ubicaci√≥n

            datos.forEach(d => {
                counts.tot++;
                let est = d.ESTADO.toLowerCase();
                let color = "#6c757d"; // Gris por defecto
                
                if(est.includes("pendiente")) { color = "#dc3545"; counts.p++; }
                else if(est.includes("proceso")) { color = "#007bff"; counts.ep++; }
                else if(est.includes("finalizado")) { color = "#28a745"; counts.f++; }
                else { counts.o++; }

                if(!isNaN(d.LAT) && !isNaN(d.LON)) {
                    // --- L√ìGICA DE DISPERSI√ìN (ANTI-JUNTADO) ---
                    let llave = `${d.LAT}_${d.LON}`;
                    let latFinal = d.LAT;
                    let lonFinal = d.LON;

                    if (coordsUsadas[llave]) {
                        // Si la coordenada ya existe, le sumamos un peque√±√≠simo margen
                        // para que el punto se vea al lado del otro
                        let angulo = coordsUsadas[llave] * (Math.PI / 4); 
                        latFinal += Math.cos(angulo) * 0.00015; 
                        lonFinal += Math.sin(angulo) * 0.00015;
                        coordsUsadas[llave]++;
                    } else {
                        coordsUsadas[llave] = 1;
                    }

                    const m = L.circleMarker([latFinal, lonFinal], {
                        radius: 7, fillColor: color, color: "#fff", weight: 2, fillOpacity: 0.9
                    });
                    
                    m.bindTooltip(d.ID, { permanent: true, className: 'etiqueta-id', direction: 'top', offset: [0,-5] });
                    m.bindPopup(`<b>ID: ${d.ID}</b><br>${d.ZONA}<br>${d.DETALLE}`);
                    markerLayer.addLayer(m);
                }

                tbody.innerHTML += `<tr>
                    <td>${d.ID}</td><td>${d.ZONA}</td><td>${d.DETALLE}</td>
                    <td>${d.LAT}</td><td>${d.LON}</td><td>${d.ESTADO}</td>
                    <td><button onclick="map.setView([${d.LAT},${d.LON}],18)">üìç IR</button></td>
                </tr>`;
            });

            document.getElementById("res-total").innerText = counts.tot;
            document.getElementById("res-pend").innerText = counts.p;
            document.getElementById("res-proc").innerText = counts.ep;
            document.getElementById("res-fin").innerText = counts.f;
            document.getElementById("res-nr").innerText = counts.o;
        }
    </script>
</body>
</html>
