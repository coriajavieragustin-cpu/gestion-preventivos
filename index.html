<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel PGP V1.8 - Gesti√≥n Firestore</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* ESTILOS */
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin:15px; background-color: #f0f2f5; color: #333; }
        .header-app { display: flex; align-items: center; background: #fff; padding: 10px 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 10px; gap: 15px; }
        .header-logo { height: 45px; width: auto; object-fit: contain; }
        .header-app h2 { margin: 0; font-size: 18px; color: #1a73e8; }
        .user-identity { margin-left: auto; display: flex; align-items: center; gap: 8px; background: #f8f9fa; padding: 5px 12px; border-radius: 20px; border: 1px solid #e0e0e0; }
        .user-identity input { border: none; background: transparent; font-weight: bold; color: #1a73e8; outline: none; width: 150px; }

        #login-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #1a237e; display: flex; justify-content: center; align-items: center; z-index: 9999; 
        }
        .login-card { 
            background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); 
            width: 320px; text-align: center; 
        }
        .login-card h2 { color: #1a73e8; margin-bottom: 20px; }
        .login-card input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn-login { width: 100%; background: #1a73e8; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; }
        
        #app-container { display: none; }

        .status-bar { display: flex; justify-content: space-between; padding: 8px 20px; background: #fff; border-radius: 8px; margin-bottom: 10px; font-size: 12px; font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 5px solid #ccc; }
        .status-ok { border-left-color: #28a745; color: #28a745; }
        .status-error { border-left-color: #dc3545; color: #dc3545; }
        .status-loading { border-left-color: #ffc107; color: #856404; }

        .resumen-estados { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .card-conteo { padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; background: #fff; border: 1px solid #ddd; font-size: 10px; }
        .card-conteo span { display: block; font-size: 22px; margin-top: 4px; }
        .conteo-pendiente { border-top: 4px solid #dc3545; color: #dc3545; }
        .conteo-proceso { border-top: 4px solid #007bff; color: #007bff; }
        .conteo-finalizado { border-top: 4px solid #28a745; color: #28a745; }

        .panel-central { display: grid; grid-template-columns: 1.6fr 1fr; gap: 15px; margin-bottom: 15px; height: 450px; }
        #mapa-general { height: 100%; border-radius: 8px; border: 2px solid #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .stats-columna { display: flex; flex-direction: column; gap: 10px; height: 100%; overflow: hidden; }
        .stats-box { background: #fff; padding: 12px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); flex: 1; overflow-y: auto; }
        
        .controles { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        button { padding: 10px 16px; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .btn-nueva { background: #28a745; } 
        .btn-drive { background: #1fa463; }
        .btn-logout { background: #666; font-size: 10px; padding: 5px 10px; }

        .filtros-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; background: #f8f9fa; padding: 15px; border-radius: 8px; }
        .input-busqueda { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }

        .contenedor-tabla { background: #fff; border-radius: 8px; overflow: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-height: 500px; }
        table.tabla-principal { border-collapse: collapse; width: 100%; min-width: 1200px; }
        .tabla-principal th { padding: 12px; background: #f8f9fa; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #dee2e6; }
        .tabla-principal td { padding: 8px 12px; font-size: 11px; border-bottom: 1px solid #eee; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: #fff; padding: 25px; border-radius: 16px; width: 480px; display: flex; flex-direction: column; gap: 12px; }
        .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .campo-full { grid-column: span 2; }
        .modal-content input, .modal-content select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn-modal-save { background: #4f46e5; color: white; padding: 12px; border-radius: 10px; border:none; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-card">
            <h2>Acceso PGP</h2>
            <input type="email" id="login-email" placeholder="Usuario (Email)">
            <input type="password" id="login-pass" placeholder="Contrase√±a">
            <button class="btn-login" onclick="window.iniciarSesion()">Entrar al Panel</button>
            <p id="login-error" style="color:red; font-size: 12px; margin-top: 10px; display:none;">Error de acceso</p>
        </div>
    </div>

    <div id="app-container">
        <div class="header-app">
            <h2>PGP V1.8 - Gesti√≥n Preventiva</h2>
            <div class="user-identity">
                <input type="text" id="nombreUsuarioWeb" readonly>
                <button class="btn-logout" onclick="window.cerrarSesion()">Salir</button>
            </div>
        </div>

        <div id="statusBar" class="status-bar">
            <span id="statusText">Sistema listo</span>
            <span id="statusTime">--:--:--</span>
        </div>

        <div class="resumen-estados">
            <div class="card-conteo">TOTAL <span id="res-total">0</span></div>
            <div class="card-conteo conteo-pendiente">PENDIENTES <span id="res-pend">0</span></div>
            <div class="card-conteo conteo-proceso">EN PROCESO <span id="res-proc">0</span></div>
            <div class="card-conteo conteo-finalizado">FINALIZADOS <span id="res-fin">0</span></div>
        </div>

        <div class="panel-central">
            <div id="mapa-general"></div>
            <div class="stats-columna">
                <div class="stats-box"><h3>üìç Top Zonas</h3><div id="stats-zona"></div></div>
                <div class="stats-box"><h3>üè∑Ô∏è Categor√≠as</h3><div id="stats-categoria"></div></div>
            </div>
        </div>

        <div class="controles">
            <div class="btn-group">
                <button class="btn-nueva" onclick="window.agregarFila()">‚ûï Nueva tarea</button>
                <button class="btn-drive" onclick="window.cargarDesdeGoogleSheets()">üîÑ Sincronizar Drive</button>
            </div>
            <div class="filtros-grid">
                <input type="text" id="fId" class="input-busqueda" placeholder="Buscar ID..." onkeyup="window.buscar()">
                <select id="fZon" class="input-busqueda" onchange="window.buscar()"><option value="">Todas las Zonas</option></select>
                <select id="fEst" class="input-busqueda" onchange="window.buscar()">
                    <option value="">Todos los Estados</option>
                    <option value="Pendiente">Pendiente</option>
                    <option value="En proceso">En proceso</option>
                    <option value="Finalizado">Finalizado</option>
                </select>
            </div>
        </div>

        <div class="contenedor-tabla">
            <table class="tabla-principal" id="tabla">
                <thead>
                    <tr><th>ID</th><th>FECHA</th><th>ZONA</th><th>DETALLE</th><th>LAT</th><th>LON</th><th>ESC</th><th>CATEG</th><th>ESTADO</th><th>ACCIONES</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="modalTarea" class="modal-overlay">
        <div class="modal-content">
            <h3>Detalle de Tarea</h3>
            <div class="modal-grid">
                <div class="campo-full"><label>ID</label><input type="text" id="m_id" readonly></div>
                <div><label>Fecha</label><input type="text" id="m_fec"></div>
                <div><label>Zona</label><input type="text" id="m_zon"></div>
                <div class="campo-full"><label>Detalle</label><input type="text" id="m_det"></div>
                <div><label>Latitud</label><input type="text" id="m_lat"></div>
                <div><label>Longitud</label><input type="text" id="m_lon"></div>
                <div><label>Categor√≠a</label><select id="m_cat"></select></div>
                <div><label>Estado</label><select id="m_est">
                    <option value="Pendiente">Pendiente</option>
                    <option value="En proceso">En proceso</option>
                    <option value="Finalizado">Finalizado</option>
                </select></div>
            </div>
            <div class="modal-buttons">
                <button class="btn-modal-save" onclick="window.guardarDesdeModal()">üíæ Guardar Cambios</button>
                <button style="background:#eee; color:#333; padding:10px; border-radius:8px; border:none; cursor:pointer;" onclick="window.cerrarModal()">Cerrar</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyAlcxnL1Vt1u0Q2CphicFBw8StogStpa4",
    authDomain: "preventivos-6a912.firebaseapp.com",
    projectId: "preventivos-6a912",
    storageBucket: "preventivos-6a912.firebasestorage.app",
    messagingSenderId: "1016985183617",
    appId: "1:1016985183617:web:6bc9b007970ee09b4f3480"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// URL del Apps Script (Aseg√∫rate de que sea la √∫ltima versi√≥n implementada)
const GAPP_URL = "https://script.google.com/macros/s/AKfycbyAK3vkD0-TYHtjLmPpN0_UzzhfF_uo5UlUoDAgv3Ebq8YmmaoyYFRPp0wwv4KVW3-g/exec"; 

let datos = [];
let filaActualIdx = null;
let map, markerLayer;

// --- AUTH ---
onAuthStateChanged(auth, (user) => {
    if (user) {
        document.getElementById("login-overlay").style.display = "none";
        document.getElementById("app-container").style.display = "block";
        document.getElementById("nombreUsuarioWeb").value = user.email.split('@')[0].toUpperCase();
        window.cargarDesdeGoogleSheets();
        setTimeout(() => map.invalidateSize(), 500);
    } else {
        document.getElementById("login-overlay").style.display = "flex";
        document.getElementById("app-container").style.display = "none";
    }
});

window.iniciarSesion = async () => {
    const email = document.getElementById("login-email").value.trim();
    const pass = document.getElementById("login-pass").value.trim();
    const errorMsg = document.getElementById("login-error");
    try {
        await signInWithEmailAndPassword(auth, email, pass);
    } catch (e) {
        errorMsg.style.display = "block";
        console.error("Error de login:", e.message);
    }
};

window.cerrarSesion = () => signOut(auth);

// --- MAPA ---
function initMap() {
    map = L.map('mapa-general').setView([-27.46, -58.83], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    markerLayer = L.layerGroup().addTo(map);
}
initMap();

const CATS = ["POSTES", "MOVIMIENTO ADSS", "VANO BAJO", "HERRAJE", "PODA", "TUTOR", "CJA / BOTELLA"];

// --- CARGA Y RENDER ---
window.cargarDesdeGoogleSheets = async function() {
    actualizarAviso('loading', '‚è≥ Sincronizando...');
    try {
        const resp = await fetch(GAPP_URL + "?cb=" + Date.now());
        const json = await resp.json();
        datos = json;
        actualizarSelects();
        window.buscar();
        actualizarAviso('ok', '‚úÖ Sincronizado');
    } catch (e) { 
        actualizarAviso('error', '‚ùå Error de conexi√≥n');
    }
};

window.buscar = function() {
    const fId = document.getElementById("fId").value.toLowerCase();
    const fZon = document.getElementById("fZon").value;
    const fEst = document.getElementById("fEst").value.toLowerCase();

    const filtrados = datos.map((d, i) => ({ item: d, originalIndex: i }))
        .filter(({ item: d }) => {
            return (d.ID || "").toString().toLowerCase().includes(fId) &&
                   (fZon === "" || d.ZONA === fZon) &&
                   (fEst === "" || (d.ESTADO||"").toLowerCase().includes(fEst));
        });
    render(filtrados);
};

function render(lista) {
    const tbody = document.querySelector("#tabla tbody");
    tbody.innerHTML = "";
    markerLayer.clearLayers();
    
    lista.forEach((entry) => {
        const d = entry.item;
        const idx = entry.originalIndex;
        
        let lat = parseFloat(d.LAT);
        let lon = parseFloat(d.LON);
        if(!isNaN(lat) && !isNaN(lon)) {
            L.circleMarker([lat, lon], { radius: 6, color: d.ESTADO === 'Finalizado' ? 'green' : 'red' }).addTo(markerLayer);
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${d.ID}</td><td>${d.FECHA}</td><td>${d.ZONA || ''}</td>
            <td>${d.DETALLE || ''}</td><td>${d.LAT || ''}</td><td>${d.LON || ''}</td>
            <td>${d.ESC || ''}</td><td>${d.CAT || ''}</td><td>${d.ESTADO || ''}</td>
            <td><button class="btn-edit" onclick="window.activarEdicion(${idx})">‚úé</button></td>
        `;
        tbody.appendChild(tr);
    });
}

// --- EDICI√ìN ---
window.activarEdicion = (idx) => {
    filaActualIdx = idx;
    const d = datos[idx];
    document.getElementById("m_id").value = d.ID;
    document.getElementById("m_fec").value = d.FECHA;
    document.getElementById("m_zon").value = d.ZONA || "";
    document.getElementById("m_det").value = d.DETALLE || "";
    document.getElementById("m_lat").value = d.LAT || "";
    document.getElementById("m_lon").value = d.LON || "";
    document.getElementById("m_cat").innerHTML = CATS.map(c => `<option value="${c}" ${c === d.CAT ? 'selected' : ''}>${c}</option>`).join("");
    document.getElementById("m_est").value = d.ESTADO || "Pendiente";
    document.getElementById("modalTarea").style.display = "flex";
};

window.guardarDesdeModal = async function() {
    const user = document.getElementById("nombreUsuarioWeb").value;
    const item = {
        ID: document.getElementById("m_id").value,
        FECHA: document.getElementById("m_fec").value,
        ZONA: document.getElementById("m_zon").value,
        DETALLE: document.getElementById("m_det").value,
        LAT: document.getElementById("m_lat").value,
        LON: document.getElementById("m_lon").value,
        CAT: document.getElementById("m_cat").value,
        ESTADO: document.getElementById("m_est").value,
        USUARIO_EDITOR: user
    };

    actualizarAviso('loading', 'üíæ Guardando...');
    try {
        // 1. Firestore
        await setDoc(doc(db, "preventivos", item.ID), item);
        
        // 2. Google Sheets
        const params = new URLSearchParams({ action: 'update', row: JSON.stringify(item), user: user });
        await fetch(GAPP_URL, { method: 'POST', mode: 'no-cors', body: params });
        
        datos[filaActualIdx] = item;
        window.cerrarModal();
        window.buscar();
        actualizarAviso('ok', '‚úÖ Guardado correctamente');
    } catch(e) {
        actualizarAviso('error', '‚ùå Error al guardar');
    }
};

window.cerrarModal = () => document.getElementById("modalTarea").style.display = "none";

function actualizarAviso(tipo, msg) {
    const bar = document.getElementById("statusBar");
    document.getElementById("statusText").innerText = msg;
    document.getElementById("statusTime").innerText = new Date().toLocaleTimeString();
    bar.className = "status-bar " + (tipo === 'ok' ? 'status-ok' : tipo === 'error' ? 'status-error' : 'status-loading');
}

function actualizarSelects() {
    const zs = [...new Set(datos.map(d => d.ZONA).filter(z => z))].sort();
    document.getElementById("fZon").innerHTML = '<option value="">Todas las Zonas</option>' + zs.map(z=>`<option>${z}</option>`).join("");
}
</script>
</body>
</html>



