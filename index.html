<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel Gesti√≥n Preventiva - FIX TOTAL</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin:15px; background: #f0f2f5; }
        .header-app { display: flex; align-items: center; background: #fff; padding: 10px 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; gap: 15px; }
        .resumen-estados { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .card-conteo { padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; background: #fff; border-top: 4px solid #ddd; }
        .card-conteo span { display: block; font-size: 24px; }
        #mapa-general { height: 500px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .contenedor-tabla { background: #fff; border-radius: 8px; overflow: auto; max-height: 600px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; font-size: 11px; min-width: 1200px; }
        th { background: #f8f9fa; position: sticky; top: 0; padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; }
        td { padding: 8px; border-bottom: 1px solid #eee; }
        button { padding: 8px 12px; cursor: pointer; border-radius: 4px; border: none; font-weight: bold; color: white; }
        .btn-sync { background: #1fa463; }
        .btn-new { background: #28a745; }
        .etiqueta-id { background: #333; color: white; padding: 2px 5px; border-radius: 3px; font-size: 10px; }
    </style>
</head>
<body>

    <div class="header-app">
        <h2>GESTI√ìN PREVENTIVOS V1.0</h2>
        <button class="btn-new" onclick="agregarFila()">‚ûï Nueva Tarea</button>
        <button class="btn-sync" id="btnSincronizar" onclick="cargarDesdeGoogleSheets()">üîÑ Sincronizar Drive</button>
    </div>

    <div class="resumen-estados">
        <div class="card-conteo" style="border-color: #1a73e8">TOTAL <span id="res-total">0</span></div>
        <div class="card-conteo" style="border-color: #dc3545">PENDIENTES <span id="res-pend">0</span></div>
        <div class="card-conteo" style="border-color: #007bff">EN PROCESO <span id="res-proc">0</span></div>
        <div class="card-conteo" style="border-color: #28a745">FINALIZADOS <span id="res-fin">0</span></div>
    </div>

    <div id="mapa-general"></div>

    <div class="contenedor-tabla">
        <table id="tabla">
            <thead>
                <tr><th>ID</th><th>FECHA</th><th>ZONA</th><th>DETALLE</th><th>LAT</th><th>LON</th><th>ESC</th><th>CATEG</th><th>ESTADO</th><th>ACCIONES</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSMvIGwGPgfBWm-SWC3aJDtBmAeJdI8frsSsOqcpKn7j_NjYHhCfXH_0OxBTCiY_L7vmrON2g6RIbnc/pub?gid=579969097&single=true&output=csv";
        
        let datos = [];
        let map = L.map('mapa-general').setView([-27.46, -58.83], 13);
        let markerLayer = L.layerGroup().addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // --- SUPER LIMPIADOR DE COORDENADAS ---
        function limpiarCoordenada(valor) {
            if (!valor) return NaN;
            // Quitamos todo lo que no sea n√∫meros o el signo menos
            let s = valor.toString().replace(/\s/g, '').trim();
            let esNegativo = s.startsWith('-');
            let soloNumeros = s.replace(/[^0-9]/g, '');

            if (soloNumeros.length < 4) return NaN;

            // Forzamos el formato: Los primeros 2 d√≠gitos son el grado (27 o 58)
            // Ejemplo: -2747774429 -> -27.47774429
            let grados = soloNumeros.substring(0, 2);
            let decimales = soloNumeros.substring(2);
            
            return parseFloat((esNegativo ? '-' : '') + grados + "." + decimales);
        }

        async function cargarDesdeGoogleSheets() {
            const btn = document.getElementById("btnSincronizar");
            btn.innerText = "‚è≥ Cargando...";
            try {
                const resp = await fetch(SHEET_URL + "&cb=" + Date.now());
                const csvText = await resp.text();
                const lineas = csvText.split(/\r?\n/);
                
                datos = [];
                for(let i = 1; i < lineas.length; i++) {
                    if(!lineas[i].trim()) continue;
                    
                    // Regex especial para ignorar comas dentro de comillas
                    const c = lineas[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.replace(/^"|"$/g, '').trim());

                    if(c.length < 6) continue;

                    datos.push({
                        ID: c[0], FECHA: c[1], ZONA: c[2], DETALLE: c[3],
                        LAT: c[4], LON: c[5], ESC: c[6], CAT: c[7],
                        ESTADO: c[8] || "Pendiente"
                    });
                }
                render();
            } catch (e) { alert("Error al sincronizar"); }
            btn.innerText = "üîÑ Sincronizar Drive";
        }

        function render() {
            const tbody = document.querySelector("#tabla tbody");
            tbody.innerHTML = "";
            markerLayer.clearLayers();
            let counts = { total: 0, pend: 0, proc: 0, fin: 0 };
            let bounds = [];

            datos.forEach((d, idx) => {
                counts.total++;
                let est = d.ESTADO.toLowerCase();
                if(est.includes("pend")) counts.pend++;
                else if(est.includes("proc")) counts.proc++;
                else if(est.includes("fin")) counts.fin++;

                let lat = limpiarCoordenada(d.LAT);
                let lon = limpiarCoordenada(d.LON);

                // Solo dibujar si son coordenadas v√°lidas
                if(!isNaN(lat) && !isNaN(lon)) {
                    const color = est.includes("pend") ? "red" : est.includes("proc") ? "blue" : "green";
                    const m = L.circleMarker([lat, lon], { radius: 8, color: "white", weight: 2, fillColor: color, fillOpacity: 0.8 });
                    m.bindPopup(`<b>ID: ${d.ID}</b><br>${d.DETALLE}`);
                    m.bindTooltip(d.ID, { permanent: true, className: 'etiqueta-id', offset: [0, -10] });
                    markerLayer.addLayer(m);
                    bounds.push([lat, lon]);
                }

                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${d.ID}</td><td>${d.FECHA}</td><td>${d.ZONA}</td>
                    <td style="max-width:300px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${d.DETALLE}</td>
                    <td>${lat.toFixed(4)}</td><td>${lon.toFixed(4)}</td>
                    <td>${d.ESC}</td><td>${d.CAT}</td>
                    <td><select onchange="datos[${idx}].ESTADO=this.value; render()"><option ${est.includes("pend")?'selected':''}>Pendiente</option><option ${est.includes("proc")?'selected':''}>En proceso</option><option ${est.includes("fin")?'selected':''}>Finalizado</option></select></td>
                    <td><button onclick="map.setView([${lat},${lon}], 18)" style="background:#666">üìç</button></td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById("res-total").innerText = counts.total;
            document.getElementById("res-pend").innerText = counts.pend;
            document.getElementById("res-proc").innerText = counts.proc;
            document.getElementById("res-fin").innerText = counts.fin;
            
            if(bounds.length > 0) map.fitBounds(bounds, {padding: [50,50]});
        }

        function agregarFila() {
            datos.unshift({ ID: "NUEVO", FECHA: new Date().toLocaleDateString(), ZONA: "", DETALLE: "", LAT: "", LON: "", ESC: "NO", CAT: "", ESTADO: "Pendiente" });
            render();
        }

        window.onload = cargarDesdeGoogleSheets;
    </script>
</body>
</html>
