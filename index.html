<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Gesti√≥n Preventiva - Versi√≥n Final</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin:15px; background-color: #f0f2f5; color: #333; }
        .header-app { display: flex; align-items: center; background: #fff; padding: 10px 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 10px; gap: 15px; }
        .header-app h2 { margin: 0; font-size: 18px; color: #1a73e8; }

        .status-bar { display: flex; justify-content: space-between; padding: 8px 20px; background: #fff; border-radius: 8px; margin-bottom: 10px; font-size: 12px; font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 5px solid #ccc; }
        .status-ok { border-left-color: #28a745; color: #28a745; }
        .status-error { border-left-color: #dc3545; color: #dc3545; }
        .status-loading { border-left-color: #ffc107; color: #856404; }

        .resumen-estados { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .card-conteo { padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; background: #fff; border: 1px solid #ddd; font-size: 10px; }
        .card-conteo span { display: block; font-size: 22px; margin-top: 4px; }
        .conteo-pendiente { border-top: 4px solid #dc3545; color: #dc3545; }
        .conteo-proceso { border-top: 4px solid #007bff; color: #007bff; }
        .conteo-finalizado { border-top: 4px solid #28a745; color: #28a745; }

        .panel-central { display: grid; grid-template-columns: 1.6fr 1fr; gap: 15px; margin-bottom: 15px; height: 450px; }
        #mapa-general { height: 100%; border-radius: 8px; border: 2px solid #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

        .stats-columna { display: flex; flex-direction: column; gap: 10px; height: 100%; overflow: hidden; }
        .stats-box { background: #fff; padding: 12px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); flex: 1; overflow-y: auto; }
        .stats-box h3 { margin: 0 0 8px 0; font-size: 13px; color: #444; border-bottom: 1px solid #eee; padding-bottom: 4px; }
        .stats-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .stats-table td { padding: 4px 0; border-bottom: 1px dotted #eee; }

        .controles { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }

        button { padding: 10px 16px; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .btn-nueva { background: #28a745; }
        .btn-drive { background: #1fa463; }
        .btn-export { background: #17a2b8; }
        .btn-import { background: #ffc107; color: #333; }
        .btn-borrar { background: #dc3545; }

        .filtros-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; background: #f8f9fa; padding: 15px; border-radius: 8px; }
        .grupo-filtro { display: flex; flex-direction: column; gap: 5px; }
        .grupo-filtro label { font-size: 10px; font-weight: bold; color: #666; text-transform: uppercase; }
        .input-busqueda { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }

        .contenedor-tabla { background: #fff; border-radius: 8px; overflow: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-height: 500px; }
        table.tabla-principal { border-collapse: collapse; width: 100%; min-width: 1400px; }
        .tabla-principal th { padding: 12px; background: #f8f9fa; color: #666; font-size: 11px; text-align: left; border-bottom: 2px solid #dee2e6; position: sticky; top: 0; z-index: 10; }
        .tabla-principal td { padding: 8px 12px; font-size: 11px; border-bottom: 1px solid #eee; }

        .estado-pendiente { background-color: #fff5f5; }
        .estado-enproceso { background-color: #f0f7ff; }
        .estado-finalizado { background-color: #f2fff5; }
    </style>
</head>
<body>

<div class="header-app">
    <h2>GESTI√ìN PREVENTIVOS V1.0</h2>
</div>

<div id="statusBar" class="status-bar">
    <span id="statusText">Sistema preparado</span>
    <span id="statusTime">--:--:--</span>
</div>

<div class="resumen-estados">
    <div class="card-conteo">TOTAL <span id="res-total">0</span></div>
    <div class="card-conteo conteo-pendiente">PENDIENTES <span id="res-pend">0</span></div>
    <div class="card-conteo conteo-proceso">EN PROCESO <span id="res-proc">0</span></div>
    <div class="card-conteo conteo-finalizado">FINALIZADOS <span id="res-fin">0</span></div>
</div>

<div class="panel-central">
    <div id="mapa-general"></div>
    <div class="stats-columna">
        <div class="stats-box"><h3>üìÖ Historial Cierres</h3><div id="stats-mes"></div></div>
        <div class="stats-box"><h3>üìç Top Zonas</h3><div id="stats-zona"></div></div>
        <div class="stats-box"><h3>üè∑Ô∏è Categor√≠as</h3><div id="stats-categoria"></div></div>
    </div>
</div>

<div class="controles">
    <div class="btn-group">
        <button class="btn-nueva" onclick="agregarFila()">‚ûï Nueva tarea</button>
        <button class="btn-drive" onclick="cargarDesdeGoogleSheets()">‚òÅÔ∏è Sincronizar Drive</button>
        <button class="btn-export" onclick="exportarCSV()">üì• Exportar CSV</button>
        <button class="btn-import" onclick="document.getElementById('inputImport').click()">üì§ Importar CSV</button>
        <button class="btn-borrar" onclick="borrarTodo()">üóëÔ∏è Borrar todo</button>
        <input type="file" id="inputImport" accept=".csv" style="display:none" onchange="importarCSV(event)">
    </div>

    <div class="filtros-grid">
        <div class="grupo-filtro"><label>ID Tarea</label><input type="text" id="fId" class="input-busqueda" onkeyup="buscar()"></div>
        <div class="grupo-filtro"><label>Fecha</label><input type="text" id="fFec" class="input-busqueda" onkeyup="buscar()"></div>
        <div class="grupo-filtro"><label>Zona</label><select id="fZon" class="input-busqueda" onchange="buscar()"><option value="">Todas</option></select></div>
        <div class="grupo-filtro"><label>Categor√≠a</label><select id="fCat" class="input-busqueda" onchange="buscar()"><option value="">Todas</option></select></div>
        <div class="grupo-filtro"><label>Estado</label><select id="fEst" class="input-busqueda" onchange="buscar()"><option value="">Todos</option><option>Pendiente</option><option>En proceso</option><option>Finalizado</option></select></div>
    </div>
</div>

<div class="contenedor-tabla">
    <table class="tabla-principal" id="tabla">
        <thead>
            <tr><th>ID</th><th>FECHA</th><th>ZONA</th><th>DETALLE</th><th>LAT</th><th>LON</th><th>ESC</th><th>CATEG</th><th>ESTADO</th><th>CIERRE</th><th>ACCIONES</th></tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSMvIGwGPgfBWm-SWC3aJDtBmAeJdI8frsSsOqcpKn7j_NjYHhCfXH_0OxBTCiY_L7vmrON2g6RIbnc/pub?gid=579969097&single=true&output=csv";

/* üîπ CATEGOR√çAS FIJAS */
const CATEGORIAS_FIJAS = [
  "POSTES",
  "MOVIMIENTO ADSS",
  "VANO BAJO",
  "HERRAJE",
  "PODA",
  "INTERVENCION DE TERCEROS",
  "NO SE PUEDE REPARAR",
  "FO LASTIMADA URGENTE",
  "TUTOR",
  "CAJA / BOTELLA"
];

let datos = [];
let map = L.map('mapa-general').setView([-27.46, -58.83], 13);
let markerLayer = L.layerGroup().addTo(map);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

function actualizarAviso(tipo, mensaje) {
    const bar = document.getElementById("statusBar");
    document.getElementById("statusText").innerText = mensaje;
    document.getElementById("statusTime").innerText = new Date().toLocaleTimeString();
    bar.className = "status-bar " + (tipo === 'ok' ? 'status-ok' : tipo === 'error' ? 'status-error' : 'status-loading');
}

function limpiarCoordenada(valor) {
    if (!valor) return NaN;
    let s = valor.toString().replace(/\s/g, '').trim();
    let esNegativo = s.startsWith('-');
    let soloNumeros = s.replace(/[^0-9]/g, '');
    if (soloNumeros.length < 4) return NaN;
    let res = parseFloat((esNegativo ? '-' : '') + soloNumeros.substring(0, 2) + "." + soloNumeros.substring(2));
    return (res > 90 || res < -90) ? NaN : res;
}

async function cargarDesdeGoogleSheets() {
    actualizarAviso('loading', '‚è≥ Conectando con Google Drive...');
    try {
        const resp = await fetch(SHEET_URL + "&cb=" + Date.now());
        const csvText = await resp.text();
        procesarCSV(csvText);
        actualizarAviso('ok', '‚úÖ Datos de Drive cargados');
    } catch (e) {
        actualizarAviso('error', '‚ùå Error de sincronizaci√≥n');
    }
}

function procesarCSV(texto) {
    const lineas = texto.split(/\r?\n/);
    datos = [];
    for (let i = 1; i < lineas.length; i++) {
        if (!lineas[i].trim()) continue;
        const c = lineas[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.replace(/^"|"$/g, '').trim());
        if (c.length < 6) continue;
        datos.push({
            ID: c[0], FECHA: c[1], ZONA: c[2], DETALLE: c[3],
            LAT: c[4], LON: c[5], ESC: c[6], CAT: c[7],
            ESTADO: c[8] || "Pendiente", CIERRE: c[9] || ""
        });
    }
    actualizarSelects();
    buscar();
}

function actualizarSelects() {
    const zs = [...new Set(datos.map(d => d.ZONA))].sort();
    const csDatos = datos.map(d => d.CAT).filter(c => c && c.trim() !== "");
    const cs = [...new Set([...CATEGORIAS_FIJAS, ...csDatos])].sort();

    document.getElementById("fZon").innerHTML =
        '<option value="">Todas</option>' + zs.map(z => `<option>${z}</option>`).join("");

    document.getElementById("fCat").innerHTML =
        '<option value="">Todas</option>' + cs.map(c => `<option>${c}</option>`).join("");
}

/* --- resto del JS sin cambios --- */

window.onload = cargarDesdeGoogleSheets;
</script>
</body>
</html>
