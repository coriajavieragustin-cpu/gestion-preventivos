<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Gesti√≥n Preventiva V1.3 - Full</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* --- ESTILOS GENERALES --- */
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin:15px; background-color: #f0f2f5; color: #333; }
        .header-app { display: flex; align-items: center; background: #fff; padding: 10px 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 10px; gap: 15px; }
        .header-app h2 { margin: 0; font-size: 18px; color: #1a73e8; }
        .status-bar { display: flex; justify-content: space-between; padding: 8px 20px; background: #fff; border-radius: 8px; margin-bottom: 10px; font-size: 12px; font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 5px solid #ccc; }
        .status-ok { border-left-color: #28a745; color: #28a745; }
        .status-error { border-left-color: #dc3545; color: #dc3545; }
        .status-loading { border-left-color: #ffc107; color: #856404; }
        
        .resumen-estados { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .card-conteo { padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; background: #fff; border: 1px solid #ddd; font-size: 10px; }
        .card-conteo span { display: block; font-size: 22px; margin-top: 4px; }
        .conteo-pendiente { border-top: 4px solid #dc3545; color: #dc3545; }
        .conteo-proceso { border-top: 4px solid #007bff; color: #007bff; }
        .conteo-finalizado { border-top: 4px solid #28a745; color: #28a745; }

        .panel-central { display: grid; grid-template-columns: 1.6fr 1fr; gap: 15px; margin-bottom: 15px; height: 450px; }
        #mapa-general { height: 100%; border-radius: 8px; border: 2px solid #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .stats-columna { display: flex; flex-direction: column; gap: 10px; height: 100%; overflow: hidden; }
        .stats-box { background: #fff; padding: 12px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); flex: 1; overflow-y: auto; }
        .stats-box h3 { margin: 0 0 8px 0; font-size: 13px; color: #444; border-bottom: 1px solid #eee; padding-bottom: 4px; }
        .stats-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .stats-table td { padding: 4px 0; border-bottom: 1px dotted #eee; }

        .controles { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        button { padding: 10px 16px; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .btn-nueva { background: #28a745; } 
        .btn-drive { background: #1fa463; }
        .btn-export { background: #17a2b8; } 
        .btn-import { background: #ffc107; color: #333; }
        .btn-borrar { background: #dc3545; }

        .filtros-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; background: #f8f9fa; padding: 15px; border-radius: 8px; }
        .grupo-filtro { display: flex; flex-direction: column; gap: 5px; }
        .grupo-filtro label { font-size: 10px; font-weight: bold; color: #666; text-transform: uppercase; }
        .input-busqueda { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }

        .contenedor-tabla { background: #fff; border-radius: 8px; overflow: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-height: 500px; }
        table.tabla-principal { border-collapse: collapse; width: 100%; min-width: 1400px; }
        .tabla-principal th { padding: 12px; background: #f8f9fa; color: #666; font-size: 11px; text-align: left; border-bottom: 2px solid #dee2e6; position: sticky; top: 0; z-index: 10; }
        .tabla-principal td { padding: 8px 12px; font-size: 11px; border-bottom: 1px solid #eee; }
        
        .estado-pendiente { background-color: #fff5f5; }
        .estado-enproceso { background-color: #f0f7ff; }
        .estado-finalizado { background-color: #f2fff5; }
        
        .action-btn { padding:6px 8px; border-radius:6px; font-size:11px; color:#fff; border:none; cursor:pointer; }
        .btn-edit { background:#007bff; }

        /* --- ESTILOS DEL MODAL --- */
        .modal-overlay {
            display: none; 
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }
        .modal-content {
            background: #fff;
            padding: 25px;
            border-radius: 16px;
            width: 480px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .modal-content h3 { margin: 0 0 10px 0; font-size: 20px; color: #1a237e; }
        .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .campo-full { grid-column: span 2; }
        .modal-content label { font-size: 11px; font-weight: bold; color: #555; display: block; margin-bottom: 4px; }
        .modal-content input, .modal-content select {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;
        }
        .modal-buttons { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; }
        
        .btn-modal-save { background: #4f46e5; color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: bold; }
        .btn-modal-delete { background: #fee2e2; color: #dc2626; border: 1px solid #fecaca; padding: 10px; border-radius: 10px; cursor: pointer; font-weight: bold; margin-top: 5px; }
        .btn-modal-close { background: #f8f9fa; color: #444; border: 1px solid #ddd; padding: 12px; border-radius: 10px; cursor: pointer; }
        
        .btn-modal-save:hover { background: #4338ca; }
        .btn-modal-delete:hover { background: #fca5a5; }
    </style>
</head>
<body>

    <div class="header-app"><h2>GESTI√ìN PREVENTIVOS V1.3</h2></div>

    <div id="statusBar" class="status-bar">
        <span id="statusText">Sistema preparado</span>
        <span id="statusTime">--:--:--</span>
    </div>

    <div class="resumen-estados">
        <div class="card-conteo">TOTAL <span id="res-total">0</span></div>
        <div class="card-conteo conteo-pendiente">PENDIENTES <span id="res-pend">0</span></div>
        <div class="card-conteo conteo-proceso">EN PROCESO <span id="res-proc">0</span></div>
        <div class="card-conteo conteo-finalizado">FINALIZADOS <span id="res-fin">0</span></div>
    </div>

    <div class="panel-central">
        <div id="mapa-general"></div>
        <div class="stats-columna">
            <div class="stats-box"><h3>üìç Top Zonas</h3><div id="stats-zona"></div></div>
            <div class="stats-box"><h3>üè∑Ô∏è Categor√≠as</h3><div id="stats-categoria"></div></div>
        </div>
    </div>

    <div class="controles">
        <div class="btn-group">
            <button class="btn-nueva" onclick="agregarFila()">‚ûï Nueva tarea</button>
            <button class="btn-drive" onclick="cargarDesdeGoogleSheets()">‚òÅÔ∏è Sincronizar Drive</button>
            <button class="btn-export" onclick="exportarCSV()">üì• Exportar CSV</button>
            <button class="btn-import" onclick="document.getElementById('inputImport').click()">üì§ Importar CSV</button>
            <button class="btn-borrar" onclick="borrarTodo()">üóëÔ∏è Borrar todo local</button>
            <input type="file" id="inputImport" accept=".csv" style="display:none" onchange="importarCSV(event)">
        </div>
        
        <div class="filtros-grid">
            <div class="grupo-filtro"><label>ID Tarea</label><input type="text" id="fId" class="input-busqueda" onkeyup="buscar()"></div>
            <div class="grupo-filtro"><label>Fecha</label><input type="text" id="fFec" class="input-busqueda" onkeyup="buscar()"></div>
            <div class="grupo-filtro"><label>Zona</label><select id="fZon" class="input-busqueda" onchange="buscar()"><option value="">Todas</option></select></div>
            <div class="grupo-filtro"><label>Categor√≠a</label><select id="fCat" class="input-busqueda" onchange="buscar()"><option value="">Todas</option></select></div>
            <div class="grupo-filtro"><label>Estado</label><select id="fEst" class="input-busqueda" onchange="buscar()"><option value="">Todos</option><option value="Pendiente">Pendiente</option><option value="En proceso">En proceso</option><option value="Finalizado">Finalizado</option></select></div>
        </div>
    </div>

    <div class="contenedor-tabla">
        <table class="tabla-principal" id="tabla">
            <thead>
                <tr><th>ID</th><th>FECHA</th><th>ZONA</th><th>DETALLE</th><th>LAT</th><th>LON</th><th>ESC</th><th>CATEG</th><th>ESTADO</th><th>CIERRE</th><th>ACCIONES</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="modalTarea" class="modal-overlay">
        <div class="modal-content">
            <h3>Detalle de Tarea</h3>
            <div class="modal-grid">
                <div class="campo-full">
                    <label>ID Tarea</label>
                    <input type="text" id="m_id">
                </div>
                <div>
                    <label>Fecha</label>
                    <input type="text" id="m_fec">
                </div>
                <div>
                    <label>Zona</label>
                    <input type="text" id="m_zon">
                </div>
                <div class="campo-full">
                    <label>Actividad / Detalle</label>
                    <input type="text" id="m_det">
                </div>
                <div>
                    <label>Latitud</label>
                    <input type="text" id="m_lat">
                </div>
                <div>
                    <label>Longitud</label>
                    <input type="text" id="m_lon">
                </div>
                <div>
                    <label>Categor√≠a</label>
                    <select id="m_cat"></select>
                </div>
                <div>
                    <label>Estado</label>
                    <select id="m_est">
                        <option value="Pendiente">Pendiente</option>
                        <option value="En proceso">En proceso</option>
                        <option value="Finalizado">Finalizado</option>
                    </select>
                </div>
                <div>
                    <label>Escalado</label>
                    <select id="m_esc">
                        <option value="NO">NO</option>
                        <option value="SI">SI</option>
                    </select>
                </div>
                <div>
                    <label>Cierre</label>
                    <input type="text" id="m_cie">
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn-modal-save" onclick="guardarDesdeModal()">üíæ Guardar Cambios</button>
                <button class="btn-modal-close" onclick="cerrarModal()">Cerrar</button>
                <button class="btn-modal-delete" onclick="borrarFilaActual()">üóëÔ∏è Eliminar Fila</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// --- CONFIGURACI√ìN ---
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSMvIGwGPgfBWm-SWC3aJDtBmAeJdI8frsSsOqcpKn7j_NjYHhCfXH_0OxBTCiY_L7vmrON2g6RIbnc/pub?gid=579969097&single=true&output=csv";
const GAPP_URL = "https://script.google.com/macros/s/AKfycbzGqbeqI_NWa53sFPCRvez-8eMHF34lQn8SQY5CiIMsMpS85f70374SPUHfC31Whuf9/exec"; 

let datos = [];
let filaActualIdx = null; 
let map = L.map('mapa-general').setView([-27.46, -58.83], 13);
let markerLayer = L.layerGroup().addTo(map);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const CATS = ["POSTES", "MOVIMIENTO ADSS", "VANO BAJO", "HERRAJ E", "PODA", "INTERVENCION DE TERRENO", "NO SE PUEDE REPARAR", "FO LASTIMADA URGENTE", "TUTOR", "CJA / BOTELLA"];

// --- UTILIDADES ---
function actualizarAviso(tipo, mensaje) {
    const bar = document.getElementById("statusBar");
    document.getElementById("statusText").innerText = mensaje;
    document.getElementById("statusTime").innerText = new Date().toLocaleTimeString();
    bar.className = "status-bar " + (tipo === 'ok' ? 'status-ok' : tipo === 'error' ? 'status-error' : 'status-loading');
}

function limpiarCoordenada(v) {
    if (!v) return NaN;
    let s = v.toString().replace(/\s/g, '').trim();
    let esNeg = s.startsWith('-');
    let n = s.replace(/[^0-9]/g, '');
    if (n.length < 4) return NaN;
    let res = parseFloat((esNeg ? '-' : '') + n.substring(0, 2) + "." + n.substring(2));
    return (res > 90 || res < -90) ? NaN : res;
}

// --- DATOS ---
async function cargarDesdeGoogleSheets() {
    actualizarAviso('loading', '‚è≥ Conectando con Google Drive...');
    try {
        const resp = await fetch(SHEET_URL + "&cb=" + Date.now());
        const csvText = await resp.text();
        procesarCSV(csvText);
        actualizarAviso('ok', '‚úÖ Datos cargados');
    } catch (e) { actualizarAviso('error', '‚ùå Error al cargar'); }
}

function procesarCSV(texto) {
    const lineas = texto.split(/\r?\n/);
    datos = [];
    for(let i = 1; i < lineas.length; i++) {
        if(!lineas[i].trim()) continue;
        const c = lineas[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.replace(/^"|"$/g, '').trim());
        datos.push({
            ID: c[0]||'', FECHA: c[1]||'', ZONA: c[2]||'', DETALLE: c[3]||'',
            LAT: c[4]||'', LON: c[5]||'', ESC: c[6]||'NO', CAT: c[7]||'',
            ESTADO: c[8] || "Pendiente", CIERRE: c[9] || ""
        });
    }
    actualizarSelects();
    buscar();
}

function render(lista) {
    const tbody = document.querySelector("#tabla tbody");
    tbody.innerHTML = "";
    markerLayer.clearLayers();
    let cnt = { pend: 0, proc: 0, fin: 0 };
    let pZ = {}; let pC = {};

    lista.forEach((entry) => {
        const d = entry.item;
        const idx = entry.originalIndex;
        const estL = (d.ESTADO || '').toLowerCase();
        
        if(estL.includes("pend")) cnt.pend++;
        else if(estL.includes("proc")) cnt.proc++;
        else if(estL.includes("fin")) cnt.fin++;

        pZ[d.ZONA] = (pZ[d.ZONA] || 0) + 1;
        pC[d.CAT] = (pC[d.CAT] || 0) + 1;
        
        let lat = limpiarCoordenada(d.LAT);
        let lon = limpiarCoordenada(d.LON);
        if(!isNaN(lat)) {
            const col = estL.includes("pend") ? "red" : estL.includes("proc") ? "blue" : "green";
            const m = L.circleMarker([lat, lon], { radius: 7, fillColor: col, color: "#fff", weight: 2, fillOpacity: 0.9 });
            m.bindPopup(`<b>ID: ${d.ID}</b><br>${d.DETALLE}`);
            markerLayer.addLayer(m);
        }

        const tr = document.createElement("tr");
        tr.className = `estado-${estL.replace(/\s/g, '')}`;
        tr.innerHTML = `
            <td>${d.ID}</td><td>${d.FECHA}</td><td>${d.ZONA}</td>
            <td style="max-width:250px; overflow:hidden;">${d.DETALLE}</td>
            <td>${d.LAT}</td><td>${d.LON}</td><td>${d.ESC}</td><td>${d.CAT}</td>
            <td>${d.ESTADO}</td><td>${d.CIERRE}</td>
            <td>
                <button onclick="centrarMapa(${lat}, ${lon}, '${d.ID}')" style="background:#666">üìç</button>
                <button class="action-btn btn-edit" onclick="activarEdicion(${idx})">‚úé</button>
            </td>
        `;
        tbody.appendChild(tr);
    });

    document.getElementById("res-total").innerText = lista.length;
    document.getElementById("res-pend").innerText = cnt.pend;
    document.getElementById("res-proc").innerText = cnt.proc;
    document.getElementById("res-fin").innerText = cnt.fin;
    actualizarBox("stats-zona", pZ); actualizarBox("stats-categoria", pC);
}

// --- GESTI√ìN DE MODAL Y EDICI√ìN ---
function activarEdicion(idx) {
    filaActualIdx = idx;
    const d = datos[idx];
    
    document.getElementById("m_id").value = d.ID;
    document.getElementById("m_fec").value = d.FECHA;
    document.getElementById("m_zon").value = d.ZONA;
    document.getElementById("m_det").value = d.DETALLE;
    document.getElementById("m_lat").value = d.LAT;
    document.getElementById("m_lon").value = d.LON;
    document.getElementById("m_esc").value = d.ESC || "NO";
    document.getElementById("m_cie").value = d.CIERRE;
    document.getElementById("m_est").value = d.ESTADO;

    const mCat = document.getElementById("m_cat");
    mCat.innerHTML = CATS.map(c => `<option value="${c}" ${c === d.CAT ? 'selected' : ''}>${c}</option>`).join("");
    
    document.getElementById("modalTarea").style.display = "flex";
}

function cerrarModal() {
    document.getElementById("modalTarea").style.display = "none";
    filaActualIdx = null;
}

async function guardarDesdeModal() {
    if (filaActualIdx === null) return;

    const r = {
        ID: document.getElementById("m_id").value,
        FECHA: document.getElementById("m_fec").value,
        ZONA: document.getElementById("m_zon").value,
        DETALLE: document.getElementById("m_det").value,
        LAT: document.getElementById("m_lat").value,
        LON: document.getElementById("m_lon").value,
        ESC: document.getElementById("m_esc").value,
        CAT: document.getElementById("m_cat").value,
        ESTADO: document.getElementById("m_est").value,
        CIERRE: document.getElementById("m_cie").value
    };

    datos[filaActualIdx] = r;
    cerrarModal();
    actualizarAviso('loading', '‚è≥ Sincronizando cambio...');

    try {
        await fetch(GAPP_URL, { method: 'POST', mode: 'no-cors', body: new URLSearchParams({action:'update', row: JSON.stringify(r)}) });
        actualizarAviso('ok', '‚úÖ Cambios guardados');
        buscar();
    } catch(e) { 
        actualizarAviso('error', '‚ùå Error de red'); 
    }
}

// NUEVA FUNCI√ìN: BORRAR FILA
async function borrarFilaActual() {
    if (filaActualIdx === null) return;
    
    if (!confirm("¬øSeguro que deseas eliminar esta tarea permanentemente?")) return;

    const idABorrar = datos[filaActualIdx].ID;
    actualizarAviso('loading', `‚è≥ Eliminando ID: ${idABorrar}...`);

    try {
        // Opcional: Avisar al backend de la eliminaci√≥n
        // Depende de si tu Google Apps Script soporta la acci√≥n 'delete'
        await fetch(GAPP_URL, { 
            method: 'POST', 
            mode: 'no-cors', 
            body: new URLSearchParams({action:'delete', id: idABorrar}) 
        });

        // Eliminar del array local
        datos.splice(filaActualIdx, 1);
        
        cerrarModal();
        actualizarAviso('ok', 'üóëÔ∏è Fila eliminada correctamente');
        buscar();
    } catch(e) {
        actualizarAviso('error', '‚ùå Error al intentar borrar');
    }
}

// --- FILTROS Y BUSQUEDA ---
function buscar() {
    const id = document.getElementById("fId").value.toLowerCase();
    const fec = document.getElementById("fFec").value.toLowerCase();
    const zon = document.getElementById("fZon").value;
    const cat = document.getElementById("fCat").value;
    const est = document.getElementById("fEst").value.toLowerCase();

    const filtrados = datos.map((d, i) => ({ item: d, originalIndex: i }))
        .filter(({ item: d }) => {
            const eD = (d.ESTADO || "").toLowerCase();
            return d.ID.toLowerCase().includes(id) && 
                   d.FECHA.toLowerCase().includes(fec) &&
                   (zon === "" || d.ZONA === zon) &&
                   (cat === "" || d.CAT === cat) &&
                   (est === "" || eD.includes(est.substring(0,4)));
        });
    render(filtrados);
}

function centrarMapa(lat, lon, id) {
    if (isNaN(lat) || isNaN(lon)) { alert("Sin coordenadas"); return; }
    map.setView([lat, lon], 18);
    markerLayer.eachLayer(l => {
        if(l.getLatLng().lat === lat && l.getLatLng().lng === lon) l.openPopup();
    });
}

function actualizarSelects() {
    const zs = [...new Set(datos.map(d => d.ZONA))].sort();
    document.getElementById("fZon").innerHTML = '<option value="">Todas</option>' + zs.map(z=>`<option>${z}</option>`).join("");
    document.getElementById("fCat").innerHTML = '<option value="">Todas</option>' + CATS.map(c=>`<option>${c}</option>`).join("");
}

function actualizarBox(id, obj) {
    const items = Object.entries(obj).sort((a,b)=>b[1]-a[1]);
    document.getElementById(id).innerHTML = '<table class="stats-table">' + items.map(([k,v])=>`<tr><td>${k}</td><td style="text-align:right"><b>${v}</b></td></tr>`).join("") + '</table>';
}

function agregarFila() {
    const nueva = { ID:"NUEVO", FECHA:new Date().toLocaleDateString(), ZONA:"", DETALLE:"", LAT:"", LON:"", ESC:"NO", CAT:"", ESTADO:"Pendiente", CIERRE:"" };
    datos.unshift(nueva);
    activarEdicion(0);
}

function borrarTodo() { if(confirm("¬øBorrar todos los datos de la vista actual?")) { datos = []; render([]); } }

function exportarCSV() {
    let csv = "ID,FECHA,ZONA,DETALLE,LAT,LON,ESC,CAT,ESTADO,CIERRE\n";
    datos.forEach(d => csv += `"${d.ID}","${d.FECHA}","${d.ZONA}","${d.DETALLE}","${d.LAT}","${d.LON}","${d.ESC}","${d.CAT}","${d.ESTADO}","${d.CIERRE}"\n`);
    const link = document.createElement("a");
    link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
    link.download = "preventivos_export.csv";
    link.click();
}

function importarCSV(e) {
    const reader = new FileReader();
    reader.onload = () => { procesarCSV(reader.result); actualizarAviso('ok', 'üì§ CSV Importado'); };
    reader.readAsText(e.target.files[0]);
}

window.onload = cargarDesdeGoogleSheets;
</script>
</body>
</html>
