<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Gesti√≥n Preventiva - Versi√≥n Final (Mejorada)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin:15px; background-color: #f0f2f5; color: #333; }
        .header-app { display: flex; align-items: center; background: #fff; padding: 10px 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 10px; gap: 15px; }
        .header-app h2 { margin: 0; font-size: 18px; color: #1a73e8; }

        /* BARRA DE ESTADO */
        .status-bar { display: flex; justify-content: space-between; padding: 8px 20px; background: #fff; border-radius: 8px; margin-bottom: 10px; font-size: 12px; font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 5px solid #ccc; }
        .status-ok { border-left-color: #28a745; color: #28a745; }
        .status-error { border-left-color: #dc3545; color: #dc3545; }
        .status-loading { border-left-color: #ffc107; color: #856404; }

        .resumen-estados { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .card-conteo { padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; background: #fff; border: 1px solid #ddd; font-size: 10px; }
        .card-conteo span { display: block; font-size: 22px; margin-top: 4px; }
        .conteo-pendiente { border-top: 4px solid #dc3545; color: #dc3545; }
        .conteo-proceso { border-top: 4px solid #007bff; color: #007bff; }
        .conteo-finalizado { border-top: 4px solid #28a745; color: #28a745; }

        .panel-central { display: grid; grid-template-columns: 1.6fr 1fr; gap: 15px; margin-bottom: 15px; height: 450px; }
        #mapa-general { height: 100%; border-radius: 8px; border: 2px solid #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        .stats-columna { display: flex; flex-direction: column; gap: 10px; height: 100%; overflow: hidden; }
        .stats-box { background: #fff; padding: 12px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); flex: 1; overflow-y: auto; }
        .stats-box h3 { margin: 0 0 8px 0; font-size: 13px; color: #444; border-bottom: 1px solid #eee; padding-bottom: 4px; }
        .stats-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .stats-table td { padding: 4px 0; border-bottom: 1px dotted #eee; }

        .controles { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }

        /* ESTILOS BOTONES SEGUN IMAGEN */
        button { padding: 10px 16px; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .btn-nueva { background: #28a745; } 
        .btn-drive { background: #1fa463; }
        .btn-export { background: #17a2b8; } /* Color Teal de tu imagen */
        .btn-import { background: #ffc107; color: #333; } /* Color Ambar de tu imagen */
        .btn-borrar { background: #dc3545; }

        .filtros-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; background: #f8f9fa; padding: 15px; border-radius: 8px; }
        .grupo-filtro { display: flex; flex-direction: column; gap: 5px; }
        .grupo-filtro label { font-size: 10px; font-weight: bold; color: #666; text-transform: uppercase; }
        .input-busqueda { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }

        .contenedor-tabla { background: #fff; border-radius: 8px; overflow: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-height: 500px; }
        table.tabla-principal { border-collapse: collapse; width: 100%; min-width: 1400px; }
        .tabla-principal th { padding: 12px; background: #f8f9fa; color: #666; font-size: 11px; text-align: left; border-bottom: 2px solid #dee2e6; position: sticky; top: 0; z-index: 10; }
        .tabla-principal td { padding: 8px 12px; font-size: 11px; border-bottom: 1px solid #eee; }
        
        /* FILAS POR ESTADO */
        .estado-pendiente { background-color: #fff5f5; }
        .estado-enproceso { background-color: #f0f7ff; }
        .estado-finalizado { background-color: #f2fff5; }
        .etiqueta-id { background: #333; color: white; padding: 2px 6px; border-radius: 3px; font-weight: bold; font-size: 10px; }
    </style>
</head>
<body>

    <div class="header-app">
        <h2>GESTI√ìN PREVENTIVOS V1.0</h2>
    </div>

    <div id="statusBar" class="status-bar">
        <span id="statusText">Sistema preparado</span>
        <span id="statusTime">--:--:--</span>
    </div>

    <div class="resumen-estados">
        <div class="card-conteo">TOTAL <span id="res-total">0</span></div>
        <div class="card-conteo conteo-pendiente">PENDIENTES <span id="res-pend">0</span></div>
        <div class="card-conteo conteo-proceso">EN PROCESO <span id="res-proc">0</span></div>
        <div class="card-conteo conteo-finalizado">FINALIZADOS <span id="res-fin">0</span></div>
    </div>

    <div class="panel-central">
        <div id="mapa-general"></div>
        <div class="stats-columna">
            <div class="stats-box"><h3>üìÖ Historial Cierres</h3><div id="stats-mes"></div></div>
            <div class="stats-box"><h3>üìç Top Zonas</h3><div id="stats-zona"></div></div>
            <div class="stats-box"><h3>üè∑Ô∏è Categor√≠as</h3><div id="stats-categoria"></div></div>
        </div>
    </div>

    <div class="controles">
        <div class="btn-group">
            <button class="btn-nueva" onclick="agregarFila()">‚ûï Nueva tarea</button>
            <button class="btn-drive" onclick="cargarDesdeGoogleSheets()">‚òÅÔ∏è Sincronizar Drive</button>
            <button class="btn-export" onclick="exportarCSV()">üì• Exportar CSV</button>
            <button class="btn-import" onclick="document.getElementById('inputImport').click()">üì§ Importar CSV</button>
            <button class="btn-borrar" onclick="borrarTodo()">üóëÔ∏è Borrar todo</button>
            <input type="file" id="inputImport" accept=".csv" style="display:none" onchange="importarCSV(event)">
        </div>
        
        <div class="filtros-grid">
            <div class="grupo-filtro"><label>ID Tarea</label><input type="text" id="fId" class="input-busqueda" onkeyup="debouncedBuscar()"></div>
            <div class="grupo-filtro"><label>Fecha</label><input type="text" id="fFec" class="input-busqueda" placeholder="Buscar fecha..." onkeyup="debouncedBuscar()"></div>
            <div class="grupo-filtro"><label>Zona</label><select id="fZon" class="input-busqueda" onchange="buscar()"><option value="">Todas</option></select></div>
            <div class="grupo-filtro"><label>Categor√≠a</label><select id="fCat" class="input-busqueda" onchange="buscar()"><option value="">Todas</option></select></div>
            <div class="grupo-filtro"><label>Estado</label><select id="fEst" class="input-busqueda" onchange="buscar()"><option value="">Todos</option><option>Pendiente</option><option>En proceso</option><option>Finalizado</option></select></div>
        </div>
    </div>

    <div class="contenedor-tabla">
        <table class="tabla-principal" id="tabla">
            <thead>
                <tr><th>ID</th><th>FECHA</th><th>ZONA</th><th>DETALLE</th><th>LAT</th><th>LON</th><th>ESC</th><th>CATEG</th><th>ESTADO</th><th>CIERRE</th><th>ACCIONES</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
(function () {
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSMvIGwGPgfBWm-SWC3aJDtBmAeJdI8frsSsOqcpKn7j_NjYHhCfXH_0OxBTCiY_L7vmrON2g6RIbnc/pub?gid=579969097&single=true&output=csv";

    let datos = [];
    let map = L.map('mapa-general').setView([-27.46, -58.83], 13);
    let markerLayer = L.layerGroup().addTo(map);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let buscarTimeout = null;

    function actualizarAviso(tipo, mensaje) {
        const bar = document.getElementById("statusBar");
        document.getElementById("statusText").innerText = mensaje;
        document.getElementById("statusTime").innerText = new Date().toLocaleTimeString();
        bar.className = "status-bar " + (tipo === 'ok' ? 'status-ok' : tipo === 'error' ? 'status-error' : 'status-loading');
    }

    // Mejor parseo de coordenadas: acepta coma/punto, signos, espacios, y valida rangos.
    function limpiarCoordenada(valor, tipo = 'lat') {
        if (valor === null || valor === undefined) return NaN;
        let s = String(valor).trim();
        if (s === '') return NaN;
        // Reemplazar comas decimales y quitar caracteres no v√°lidos (permitir s√≥lo d√≠gitos, punto y signo menos)
        s = s.replace(',', '.').replace(/[^0-9\.\-]/g, '');
        // Evitar m√∫ltiples puntos/signos
        const parts = s.split('.');
        if (parts.length > 2) s = parts.shift() + '.' + parts.join('');
        // S√≥lo un signo '-' al inicio
        s = s.replace(/(?!^)-/g, '');
        const num = parseFloat(s);
        if (isNaN(num)) return NaN;
        if (tipo === 'lat') {
            return (num >= -90 && num <= 90) ? num : NaN;
        } else {
            return (num >= -180 && num <= 180) ? num : NaN;
        }
    }

    async function cargarDesdeGoogleSheets() {
        actualizarAviso('loading', '‚è≥ Conectando con Google Drive...');
        try {
            const resp = await fetch(SHEET_URL + "&cb=" + Date.now());
            if (!resp.ok) throw new Error('HTTP ' + resp.status);
            const csvText = await resp.text();
            procesarCSV(csvText);
            actualizarAviso('ok', '‚úÖ Datos de Drive cargados');
        } catch (e) {
            console.error(e);
            actualizarAviso('error', '‚ùå Error de sincronizaci√≥n');
        }
    }

    // Parse CSV simple pero m√°s tolerante: detecta cabecera y usa nombres de columnas si est√°n presentes.
    function procesarCSV(texto) {
        const lineas = texto.split(/\r?\n/).filter(l => l.trim().length > 0);
        if (lineas.length === 0) {
            datos = [];
            actualizarSelects();
            buscar();
            return;
        }

        // Split CSV respecting quoted fields
        const splitCSV = (line) => line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.replace(/^"|"$/g, '').trim());

        const headers = splitCSV(lineas[0]).map(h => h.toUpperCase());
        const hasHeader = headers.some(h => ['ID','FECHA','ZONA','DETALLE','LAT','LON','ESC','CAT','ESTADO','CIERRE','FINALIZACION','LATITUD','LONGITUD','CATEGORIA'].includes(h));
        const rows = hasHeader ? lineas.slice(1) : lineas;

        datos = [];
        rows.forEach((ln, i) => {
            if (!ln.trim()) return;
            const cols = splitCSV(ln);
            let obj = {};
            if (hasHeader) {
                headers.forEach((h, idx) => {
                    obj[h] = cols[idx] || '';
                });
                // Map header names to the expected keys (flexible)
                datos.push({
                    ID: obj.ID || obj[''] || (cols[0] || ''),
                    FECHA: obj.FECHA || obj['FECHA'] || (cols[1] || ''),
                    ZONA: obj.ZONA || (cols[2] || ''),
                    DETALLE: obj.DETALLE || (cols[3] || ''),
                    LAT: obj.LAT || obj.LATITUD || (cols[4] || ''),
                    LON: obj.LON || obj.LONGITUD || (cols[5] || ''),
                    ESC: obj.ESC || (cols[6] || ''),
                    CAT: obj.CAT || obj.CATEGORIA || (cols[7] || ''),
                    ESTADO: obj.ESTADO || (cols[8] || 'Pendiente'),
                    CIERRE: obj.CIERRE || obj.FINALIZACION || (cols[9] || '')
                });
            } else {
                // Fallback a posiciones fijas si no hay header
                datos.push({
                    ID: cols[0] || '',
                    FECHA: cols[1] || '',
                    ZONA: cols[2] || '',
                    DETALLE: cols[3] || '',
                    LAT: cols[4] || '',
                    LON: cols[5] || '',
                    ESC: cols[6] || '',
                    CAT: cols[7] || '',
                    ESTADO: cols[8] || 'Pendiente',
                    CIERRE: cols[9] || ''
                });
            }
        });

        // A√±adir un identificador interno (no visible) para mapear correctamente
        datos = datos.map((d, i) => ({ __idx: i, ...d }));

        actualizarSelects();
        buscar();
    }

    // render espera una lista de objetos { item: dato, originalIndex: n } para asegurar la conexi√≥n con datos
    function render(listaConIndex) {
        const tbody = document.querySelector("#tabla tbody");
        tbody.innerHTML = "";
        markerLayer.clearLayers();
        let cnt = { pend: 0, proc: 0, fin: 0 };
        let pZ = {}; let pC = {}; let pM = {}; let bounds = [];

        listaConIndex.forEach(({ item: d, originalIndex }, idx) => {
            const estL = (d.ESTADO || '').toLowerCase();
            if (estL.includes("pend")) cnt.pend++;
            else if (estL.includes("proc")) cnt.proc++;
            else if (estL.includes("fin")) cnt.fin++;

            pZ[d.ZONA] = (pZ[d.ZONA] || 0) + 1;
            pC[d.CAT] = (pC[d.CAT] || 0) + 1;
            if ((d.CIERRE || '').includes("/")) {
                const parts = d.CIERRE.split("/");
                if (parts.length >= 3) {
                    let m = parts[1] + "/" + parts[2];
                    pM[m] = (pM[m] || 0) + 1;
                }
            }

            let lat = limpiarCoordenada(d.LAT, 'lat');
            let lon = limpiarCoordenada(d.LON, 'lon');
            if (!isNaN(lat) && !isNaN(lon)) {
                const col = estL.includes("pend") ? "red" : estL.includes("proc") ? "blue" : "green";
                const m = L.circleMarker([lat, lon], { radius: 7, fillColor: col, color: "#fff", weight: 2, fillOpacity: 0.9 });
                m.bindPopup(`<b>ID: ${escapeHtml(d.ID)}</b><br>${escapeHtml(d.DETALLE)}`);
                m.bindTooltip(`${d.ID}`, { permanent: false, direction: 'top' });
                markerLayer.addLayer(m);
                bounds.push([lat, lon]);
            }

            const tr = document.createElement("tr");
            const estadoClass = estL.replace(/\s+/g, '-').replace(/[^a-z0-9\-\_]/gi,'');
            tr.className = `estado-${estadoClass}`;
            tr.innerHTML = `
                <td>${escapeHtml(d.ID)}</td>
                <td>${escapeHtml(d.FECHA)}</td>
                <td>${escapeHtml(d.ZONA)}</td>
                <td style="max-width:350px; overflow:hidden;">${escapeHtml(d.DETALLE)}</td>
                <td>${escapeHtml(d.LAT)}</td>
                <td>${escapeHtml(d.LON)}</td>
                <td>${escapeHtml(d.ESC)}</td>
                <td>${escapeHtml(d.CAT)}</td>
                <td>
                    <select data-idx="${originalIndex}" onchange="cambiarEstadoPorIndice(this.dataset.idx, this.value)">
                        <option ${estL.includes("pend") ? "selected" : ""}>Pendiente</option>
                        <option ${estL.includes("proc") ? "selected" : ""}>En proceso</option>
                        <option ${estL.includes("fin") ? "selected" : ""}>Finalizado</option>
                    </select>
                </td>
                <td>${escapeHtml(d.CIERRE)}</td>
                <td>
                    <button data-lat="${isNaN(lat)?'':lat}" data-lon="${isNaN(lon)?'':lon}" style="background:#666" onclick="centrarMapaDesdeBoton(this)">üìç</button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById("res-total").innerText = listaConIndex.length;
        document.getElementById("res-pend").innerText = cnt.pend;
        document.getElementById("res-proc").innerText = cnt.proc;
        document.getElementById("res-fin").innerText = cnt.fin;
        actualizarBox("stats-zona", pZ); actualizarBox("stats-categoria", pC); actualizarBox("stats-mes", pM);
        if (bounds.length > 0) {
            try {
                map.fitBounds(bounds, { padding: [30, 30] });
            } catch (e) {
                console.warn("fitBounds fallo:", e);
            }
        }
    }

    // Escape HTML b√°sico para evitar inyecci√≥n en los popups / tabla
    function escapeHtml(str) {
        if (str === null || str === undefined) return '';
        return String(str)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // Construye la lista filtrada pero manteniendo el √≠ndice original de datos
    function buscar() {
        const id = document.getElementById("fId").value.toLowerCase();
        const fec = document.getElementById("fFec").value.toLowerCase();
        const zon = document.getElementById("fZon").value;
        const cat = document.getElementById("fCat").value;
        const est = document.getElementById("fEst").value;

        const filtrados = datos
            .map((d, i) => ({ item: d, originalIndex: i }))
            .filter(({ item: d }) =>
                (String(d.ID || '').toLowerCase().includes(id)) &&
                (String(d.FECHA || '').toLowerCase().includes(fec)) &&
                (zon === "" || d.ZONA === zon) &&
                (cat === "" || d.CAT === cat) &&
                (est === "" || (d.ESTADO || '') === est)
            );
        render(filtrados);
    }

    function debouncedBuscar() {
        clearTimeout(buscarTimeout);
        buscarTimeout = setTimeout(buscar, 250);
    }

    function exportarCSV() {
        let csv = "ID,FECHA,ZONA,DETALLE,LATITUD,LONGITUD,ESCALERA,CATEGORIA,ESTADO,FINALIZACION\n";
        datos.forEach(d => {
            csv += `"${(d.ID||'').replace(/"/g,'""')}","${(d.FECHA||'').replace(/"/g,'""')}","${(d.ZONA||'').replace(/"/g,'""')}","${(d.DETALLE||'').replace(/"/g,'""')}","${(d.LAT||'').replace(/"/g,'""')}","${(d.LON||'').replace(/"/g,'""')}","${(d.ESC||'').replace(/"/g,'""')}","${(d.CAT||'').replace(/"/g,'""')}","${(d.ESTADO||'').replace(/"/g,'""')}","${(d.CIERRE||'').replace(/"/g,'""')}"\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        const fechaIso = new Date().toISOString().slice(0,10);
        link.download = "preventivos_export_" + fechaIso + ".csv";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function importarCSV(e) {
        const reader = new FileReader();
        reader.onload = () => {
            procesarCSV(reader.result);
            actualizarAviso('ok', 'üì§ Archivo CSV importado');
        };
        if (e && e.target && e.target.files && e.target.files[0]) {
            reader.readAsText(e.target.files[0]);
        } else {
            actualizarAviso('error', '‚ùå No se pudo leer el archivo');
        }
    }

    function actualizarSelects() {
        // Mantener selecci√≥n previa si existe
        const prevZ = document.getElementById("fZon").value;
        const prevC = document.getElementById("fCat").value;

        const zs = [...new Set(datos.map(d => d.ZONA || ''))].filter(Boolean).sort();
        const cs = [...new Set(datos.map(d => d.CAT || ''))].filter(Boolean).sort();
        document.getElementById("fZon").innerHTML = '<option value="">Todas</option>' + zs.map(z=>`<option${z===prevZ?' selected':''}>${escapeHtml(z)}</option>`).join("");
        document.getElementById("fCat").innerHTML = '<option value="">Todas</option>' + cs.map(c=>`<option${c===prevC?' selected':''}>${escapeHtml(c)}</option>`).join("");
    }

    function actualizarBox(id, obj) {
        const items = Object.entries(obj).sort((a,b)=>b[1]-a[1]);
        document.getElementById(id).innerHTML = '<table class="stats-table">' + items.map(([k,v])=>`<tr><td>${escapeHtml(k)}</td><td style="text-align:right"><b>${v}</b></td></tr>`).join("") + '</table>';
    }

    // Actualiza el estado del elemento original con su √≠ndice real
    function cambiarEstadoPorIndice(idx, val) {
        idx = Number(idx);
        if (!Number.isFinite(idx) || !datos[idx]) return;
        datos[idx].ESTADO = val;
        buscar();
    }

    function agregarFila() {
        datos.unshift({ __idx: datos.length ? (Math.max(...datos.map(d=>d.__idx))+1) : 0, ID:"NUEVO", FECHA:new Date().toLocaleDateString(), ZONA:"", DETALLE:"", LAT:"", LON:"", ESC:"NO", CAT:"", ESTADO:"Pendiente", CIERRE:"" });
        actualizarSelects();
        buscar();
    }

    function borrarTodo() {
        if (confirm("¬øBorrar todo?")) {
            datos = [];
            render([]);
            actualizarSelects();
        }
    }

    // Centrar mapa desde bot√≥n; s√≥lo si tiene lat/lon v√°lidos
    window.centrarMapaDesdeBoton = function(btn) {
        const lat = Number(btn.dataset.lat);
        const lon = Number(btn.dataset.lon);
        if (!isNaN(lat) && !isNaN(lon)) {
            try { map.setView([lat, lon], 18); } catch (e) { console.warn(e); }
        } else {
            alert("Coordenadas no v√°lidas para este item.");
        }
    };

    // Exponer funciones necesarias globalmente (para los onclick del HTML)
    window.cargarDesdeGoogleSheets = cargarDesdeGoogleSheets;
    window.exportarCSV = exportarCSV;
    window.importarCSV = importarCSV;
    window.agregarFila = agregarFila;
    window.borrarTodo = borrarTodo;
    window.buscar = buscar;
    window.debouncedBuscar = debouncedBuscar;
    window.cambiarEstadoPorIndice = cambiarEstadoPorIndice;

    // Iniciar carga autom√°tica al abrir la p√°gina
    window.onload = cargarDesdeGoogleSheets;
})();
</script>
</body>
</html>

