<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema de Gesti√≥n Corrientes V1.4</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --pend: #dc3545; --norep: #6c757d; --proc: #007bff; --fin: #28a745; }
        body { font-family: 'Segoe UI', sans-serif; margin: 15px; background: #f4f7f6; }
        
        /* Cabecera y Resumen */
        .header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .resumen { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .card { background: white; padding: 10px; border-radius: 8px; text-align: center; border-top: 4px solid #ccc; }
        .card span { display: block; font-size: 20px; font-weight: bold; }

        /* Panel Principal */
        .main-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 15px; height: 500px; margin-bottom: 15px; }
        #map { background: #eee; border-radius: 10px; border: 2px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .side-stats { background: white; padding: 15px; border-radius: 10px; overflow-y: auto; }

        /* Filtros */
        .filtros { background: #fff; padding: 20px; border-radius: 10px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .filtros label { font-size: 11px; font-weight: bold; color: #555; display: block; margin-bottom: 5px; }
        select, input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }

        /* Tabla */
        .tabla-con { background: white; border-radius: 10px; overflow: auto; max-height: 600px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; min-width: 1200px; }
        th { position: sticky; top: 0; background: #f8f9fa; padding: 12px; border-bottom: 2px solid #eee; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #eee; }

        /* Colores de Fila */
        .fila-pendiente { border-left: 6px solid var(--pend); background: #fff5f5; }
        .fila-noreparable { border-left: 6px solid var(--norep); background: #f8f9fa; }
        .fila-proceso { border-left: 6px solid var(--proc); background: #f0f7ff; }
        .fila-finalizado { border-left: 6px solid var(--fin); background: #f2fff5; }

        .btn { padding: 8px 15px; border: none; border-radius: 5px; color: white; cursor: pointer; font-weight: bold; margin-right: 5px; }
    </style>
</head>
<body>

    <div class="header">
        <h2 style="margin:0; color:#1a73e8;">GESTI√ìN PREVENTIVOS</h2>
        <div id="reloj" style="font-size: 12px; color: #666;">Cargando sistema...</div>
    </div>

    <div class="resumen">
        <div class="card" style="border-color:#333">TOTAL <span id="t-total">0</span></div>
        <div class="card" style="border-color:var(--pend)">PENDIENTES <span id="t-pend">0</span></div>
        <div class="card" style="border-color:var(--norep)">NO REPARABLES <span id="t-norep">0</span></div>
        <div class="card" style="border-color:var(--proc)">EN PROCESO <span id="t-proc">0</span></div>
        <div class="card" style="border-color:var(--fin)">FINALIZADOS <span id="t-fin">0</span></div>
    </div>

    <div class="main-grid">
        <div id="map"></div>
        <div class="side-stats">
            <h4 style="margin-top:0">Top Zonas</h4>
            <div id="lista-zonas"></div>
            <h4>Categor√≠as</h4>
            <div id="lista-cats"></div>
        </div>
    </div>

    <div class="filtros">
        <div><label>BUSCAR ID</label><input type="text" id="f-id" onkeyup="buscar()" placeholder="Escribe ID..."></div>
        <div><label>ZONA</label><select id="f-zona" onchange="buscar()"><option value="">Todas</option></select></div>
        <div>
            <label>ESTADO</label>
            <select id="f-estado" onchange="buscar()">
                <option value="">Todos</option>
                <option value="pendiente">Pendiente</option>
                <option value="no reparable">No Reparable</option>
                <option value="proceso">En proceso</option>
                <option value="finalizado">Finalizado</option>
            </select>
        </div>
        <div style="display:flex; align-items:flex-end;">
            <button class="btn" style="background:#28a745" onclick="cargarDrive()">üîÑ Sincronizar</button>
            <button class="btn" style="background:#17a2b8" onclick="exportar()">üì• Exportar</button>
        </div>
    </div>

    <div class="tabla-con">
        <table id="tabla-datos">
            <thead>
                <tr>
                    <th>ID</th><th>FECHA</th><th>ZONA</th><th>DETALLE</th>
                    <th>LAT</th><th>LON</th><th>ESC</th><th>CATEG</th>
                    <th>ESTADO</th><th>CIERRE</th><th>COMENTARIO</th><th>ACCION</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const URL_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSMvIGwGPgfBWm-SWC3aJDtBmAeJdI8frsSsOqcpKn7j_NjYHhCfXH_0OxBTCiY_L7vmrON2g6RIbnc/pub?gid=579969097&single=true&output=csv";
        let datos = [];
        let map = L.map('map').setView([-27.46, -58.83], 12);
        let markers = L.layerGroup().addTo(map);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // --- SOLUCI√ìN A COORDENADAS GIGANTES ---
        function corregirCoordenada(valor) {
            if (!valor) return NaN;
            // Quitamos todo lo que no sea n√∫mero o el signo menos
            let num = valor.toString().replace(/[^0-9-]/g, '');
            if (num.length < 4) return NaN;
            
            // Si el n√∫mero es como -274777... lo convertimos a -27.4777
            let parte1 = num.substring(0, 3); // Toma "-27"
            let parte2 = num.substring(3);    // El resto
            return parseFloat(parte1 + "." + parte2);
        }

        async function cargarDrive() {
            try {
                const r = await fetch(URL_CSV + "?cb=" + Date.now());
                const csv = await r.text();
                procesar(csv);
                document.getElementById("reloj").innerText = "√öltima carga: " + new Date().toLocaleTimeString();
                setTimeout(() => map.invalidateSize(), 500); // Arregla el mapa gris
            } catch (e) { alert("Error al conectar con Drive"); }
        }

        function procesar(texto) {
            const filas = texto.split(/\r?\n/);
            datos = [];
            // Empezamos en 1 para saltar el encabezado
            for(let i = 1; i < filas.length; i++) {
                const c = filas[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.replace(/^"|"$/g, '').trim());
                if(c.length < 9) continue;
                datos.push({
                    id: c[0], fecha: c[1], zona: c[2], detalle: c[3],
                    lat: c[4], lon: c[5], esc: c[6], cat: c[7],
                    est: c[8], cierre: c[9] || "", com: c[10] || ""
                });
            }
            llenarZonas();
            buscar();
        }

        function buscar() {
            const valId = document.getElementById("f-id").value.toLowerCase();
            const valZo = document.getElementById("f-zona").value.toLowerCase();
            const valEs = document.getElementById("f-estado").value.toLowerCase();

            const filtro = datos.filter(d => {
                const matchId = d.id.toLowerCase().includes(valId);
                const matchZo = valZo === "" || d.zona.toLowerCase() === valZo;
                // Filtro flexible para el estado
                const matchEs = valEs === "" || d.est.toLowerCase().includes(valEs);
                return matchId && matchZo && matchEs;
            });
            dibujar(filtro);
        }

        function dibujar(lista) {
            const body = document.querySelector("#tabla-datos tbody");
            body.innerHTML = "";
            markers.clearLayers();
            let c = { t:0, p:0, n:0, pr:0, f:0 };
            let bounds = [];

            lista.forEach(d => {
                c.t++;
                let st = d.est.toLowerCase();
                let clase = ""; let color = "gray";

                if(st.includes("pend")) { clase = "fila-pendiente"; color="red"; c.p++; }
                else if(st.includes("reparable")) { clase = "fila-noreparable"; color="gray"; c.n++; }
                else if(st.includes("proc")) { clase = "fila-proceso"; color="blue"; c.pr++; }
                else if(st.includes("fin")) { clase = "fila-finalizado"; color="green"; c.f++; }

                let lat = corregirCoordenada(d.lat);
                let lon = corregirCoordenada(d.lon);

                if(!isNaN(lat)) {
                    L.circleMarker([lat, lon], {radius:7, color:color, fillOpacity:0.8}).addTo(markers)
                     .bindPopup(`<b>ID: ${d.id}</b><br>${d.detalle}`);
                    bounds.push([lat, lon]);
                }

                const tr = document.createElement("tr");
                tr.className = clase;
                tr.innerHTML = `
                    <td><b>${d.id}</b></td><td>${d.fecha}</td><td>${d.zona}</td>
                    <td title="${d.detalle}">${d.detalle.substring(0,40)}...</td>
                    <td>${lat.toFixed(4)}</td><td>${lon.toFixed(4)}</td>
                    <td>${d.esc}</td><td>${d.cat}</td>
                    <td><strong>${d.est}</strong></td><td>${d.cierre}</td><td>${d.com}</td>
                    <td><button onclick="map.setView([${lat},${lon}],18)" style="cursor:pointer">üìç</button></td>
                `;
                body.appendChild(tr);
            });

            document.getElementById("t-total").innerText = c.t;
            document.getElementById("t-pend").innerText = c.p;
            document.getElementById("t-norep").innerText = c.n;
            document.getElementById("t-proc").innerText = c.pr;
            document.getElementById("t-fin").innerText = c.f;

            if(bounds.length > 0) map.fitBounds(bounds);
        }

        function llenarZonas() {
            const z = [...new Set(datos.map(d => d.zona))].sort();
            document.getElementById("f-zona").innerHTML = '<option value="">Todas</option>' + z.map(x => `<option value="${x.toLowerCase()}">${x}</option>`).join("");
        }

        function exportar() {
            let csv = "ID,FECHA,ZONA,DETALLE,LAT,LON,ESTADO\n";
            datos.forEach(d => csv += `${d.id},${d.fecha},${d.zona},${d.detalle},${d.lat},${d.lon},${d.est}\n`);
            const blob = new Blob([csv], {type:'text/csv'});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "preventivos.csv";
            a.click();
        }

        window.onload = cargarDrive;
    </script>
</body>
</html>

